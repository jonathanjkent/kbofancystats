lg.type2 <- as.numeric(leagues[i,5])
lg.type3 <- as.numeric(leagues[i,6])
lg.type1name <- as.character(leagues[i,7])
lg.type2name <- as.character(leagues[i,8])
print(paste0("Now running: ",lg.name," || League ",i," of ", nrow(leagues)))
print("Scraping...")
# Scrape page
webpage <- read_html(paste0("https://www.resultados-futbol.com/",lg.code,year,"/grupo",lg.group,"/calendario"))
local_data <- html_nodes(webpage,'.equipo1') %>%  html_nodes("a") %>% html_attr("href")
vist_data <- html_nodes(webpage,'.equipo2') %>%  html_nodes("a") %>% html_attr("href")
result_data <- html_nodes(webpage,'.rstd') %>% html_text()
dates_data <- html_nodes(webpage,'.fecha') %>% html_text()
# Create dataset of all games
games <- data.frame(home = local_data, away = vist_data, score = result_data, date = dates_data)
games$score <- str_sub(games$score, -11, -7)
# Recode dates
games <- games %>% separate(date, c("day", "month", "year"))
games$year <- as.numeric(games$year) + 2000
month <- c("Ago", "Sep", "Oct", "Nov", "Dic", "Ene", "Feb", "Mar", "Abr", "May", "Jun", "Jul")
month.num <- c(8,9,10,11,12,1,2,3,4,5,6,7)
month.recode <- cbind.data.frame(month,month.num)
games <- games %>% left_join(month.recode, by = "month")
games$date <- as.Date(with(games, paste(year, month.num, day,sep="-")), "%Y-%m-%d")
games <- games %>% select(-day, -month, -year, -month.num)
# Add jornada
teams <- length(unique(games$home))
jornadas <- (teams-1)*2
games$jornada <- rep(1:jornadas, each = (teams/2))
# Separate compeleted and uncompleted games
schedule <- games %>% filter(grepl("x|:|A", games$score) | grepl("x|'|A", games$score)) %>% select(-score)
results <- filter(games, grepl("-", games$score))
results <- filter(results, !grepl("x", results$score))
results <- results %>% separate(score, c("home.score", "away.score"))
results$home.score <- as.numeric(results$home.score)
results$away.score <- as.numeric(results$away.score)
# Create points variables
results <- mutate(results, home.points = ifelse(home.score > away.score, 3,
ifelse(home.score == away.score, 1, 0)))
results <- mutate(results, away.points = ifelse(home.score < away.score, 3,
ifelse(home.score == away.score, 1, 0)))
print("Simulating...")
# Model
weights <- weights_dc(results$date, xi=xi.set)
model <- goalmodel(goals1 = results$home.score, goals2 = results$away.score,
team1 = results$home, team2=results$away, weights = weights, rs=TRUE)
predictions <- predict_result(model, team1=schedule$home, team2=schedule$away, return_df = TRUE)
# Simulate unplayed games
sims <- data.frame(predictions, sim.number = rep(1:n.sim, each = nrow(predictions)))
sims$random <- runif((nrow(sims)),0,1)
sims <- mutate(sims, team1.points = ifelse(random < p1, 3,
ifelse(random > (1-p2), 0, 1)))
sims <- mutate(sims, team2.points = ifelse(team1.points == 0, 3,
ifelse(team1.points == 3, 0, 1)))
# Add in known results
results.for.sims <- data.frame(results, sim.number = rep(1:n.sim, each = nrow(results)))
results.for.sims <- results.for.sims %>% select(home, away, sim.number, home.points, away.points, home.score, away.score)
names(results.for.sims) <- c("team1","team2","sim.number","team1.points","team2.points","team1.score","team2.score")
sim.seasons <- sims %>% select(team1,team2,sim.number,team1.points,team2.points)
sim.seasons$team1.score <- sim.seasons$team1.points/2
sim.seasons$team2.score <- sim.seasons$team2.points/2
sim.seasons <- rbind(sim.seasons,results.for.sims)
# Add in opposite leg (home/away) for each matchup
sim.seasons$matchup <- paste0(sim.seasons$team1,sim.seasons$team2,sim.seasons$sim.number)
legs <- sim.seasons
legs$matchup <- paste0(sim.seasons$team2,sim.seasons$team1,sim.seasons$sim.number)
legs <- legs %>% select(-team1,-team2,-sim.number)
names(legs) <- c("team2.points.leg","team1.points.leg","team2.score.leg","team1.score.leg","matchup")
sim.seasons <- sim.seasons %>% left_join(legs, by = "matchup")
# Tally matchup points and goal differential
sim.seasons$team1.matchup.points <- sim.seasons$team1.points + sim.seasons$team1.points.leg
sim.seasons$team1.matchup.gd <- sim.seasons$team1.score + sim.seasons$team1.score.leg - sim.seasons$team2.score - sim.seasons$team2.score.leg
# Matchups as dataframe
matchups <- sim.seasons %>% select(matchup,team1.matchup.points,team1.matchup.gd)
# Create table for each simulated season
sim.tables <- sim.seasons %>% group_by(team1,sim.number) %>% summarize(points = sum(team1.matchup.points)) %>% arrange(desc(points)) %>% arrange(sim.number)
# Create first and second tiebreakers
sim.tables$tie.team <- c(rep(NA, 1), as.character(sim.tables$team1))[1 : length(sim.tables$team1)]
sim.tables$tie.points <- c(rep(NA, 1), sim.tables$points)[1 : length(sim.tables$points)]
sim.tables$matchup <- paste0(sim.tables$team1,sim.tables$tie.team,sim.tables$sim.number)
sim.tables <- sim.tables %>% left_join(matchups, by = "matchup")
sim.tables$tiebreak1 <- ifelse(sim.tables$points == sim.tables$tie.points, sim.tables$team1.matchup.points, 2)
sim.tables$tiebreak2 <- ifelse(sim.tables$points == sim.tables$tie.points, sim.tables$team1.matchup.gd, 0)
sim.tables$team <- sim.tables$team1
sim.tables <- sim.tables %>% ungroup() %>% select(team,sim.number, points, tiebreak1, tiebreak2)
# Add third tiebreaker (goal differential) and sort
gd <- predict_expg(model, team1=schedule$home, team2=schedule$away, return_df = TRUE)
gd$t1gd <- gd$expg1-gd$expg2
gd$t2gd <- gd$expg2-gd$expg1
results$home.gd <- results$home.score-results$away.score
results$away.gd <- results$away.score-results$home.score
lg.gd <- as_tibble_col(c(as.character(results$home),as.character(results$away),as.character(gd$team1), as.character(gd$team2)),column_name = "team")
lg.gd$gd <- c(as.numeric(results$home.gd),as.numeric(results$away.gd),as.numeric(gd$t1gd), as.numeric(gd$t2gd))
lg.gd <- lg.gd %>% group_by(team) %>% summarize(gd = sum(gd))
sim.tables <- sim.tables %>% left_join(lg.gd, by = "team")
sim.table <- sim.tables %>% arrange(desc(gd)) %>% arrange(desc(tiebreak2)) %>% arrange(desc(tiebreak1)) %>% arrange(desc(points)) %>% arrange(sim.number)
# Add rank
sim.tables$rank <- rep(1:teams, times = (nrow(sim.tables)/teams))
type1 <- sim.tables %>% filter(rank <= lg.type1) %>%
group_by(team) %>% count() %>% mutate(type1 = (n/n.sim)*100) %>% select(-n) %>% ungroup()
type2 <- sim.tables %>% filter(rank < lg.type2) %>%
group_by(team) %>% count() %>% mutate(type2 = (n/n.sim)*100) %>% select(-n) %>% ungroup()
type3 <- sim.tables %>% filter(rank > lg.type3) %>%
group_by(team) %>% count() %>% mutate(type3 = (n/n.sim)*100) %>% select(-n) %>% ungroup()
typex <- sim.tables %>% filter(rank == 5 | rank == 6) %>%
group_by(team) %>% count() %>% mutate(typex = (n/n.sim)*100) %>% select(-n) %>% ungroup()
print("Simulation Complete")
# Create xGols
rate.sked <- results %>% select(home)
rate.sked <- unique(rate.sked)
colnames(rate.sked) <- "team"
rate.sked$team2 <- "nobody"
n <- nrow(rate.sked)+1
xgmodel <- model
xgmodel$parameters$attack[n] <- 0
names(xgmodel$parameters$attack[n]) <- c("nobody")
newnames <- names(xgmodel$parameters$attack)
newnames[n] <- "nobody"
names(xgmodel$parameters$attack) <- newnames
xgmodel$parameters$defense[n] <- 0
newnames <- names(xgmodel$parameters$defense)
newnames[n] <- "nobody"
names(xgmodel$parameters$defense) <- newnames
xgmodel$all_teams[n] <- "nobody"
rate.preds <- predict_expg(xgmodel, team1=rate.sked$team, team2=rate.sked$team2, return_df = TRUE)
rate.preds.away <- predict_expg(xgmodel, team1=rate.sked$team2, team2=rate.sked$team, return_df = TRUE)
rate.preds.away$team1 <- rate.preds.away$team2
rate.preds <- rate.preds %>% select(-team2) %>% left_join(rate.preds.away, by = "team1")
rate.preds$expg1 <- (rate.preds$expg1.x + rate.preds$expg2.y)/2
rate.preds$expg2 <- (rate.preds$expg2.x + rate.preds$expg1.y)/2
xgols <- rate.preds %>% select(team1, expg1, expg2) %>% rename(
team = team1,
off.rank = expg1,
def.rank = expg2)
# Create final table
final.table <- sim.tables %>% group_by(team) %>% summarize(proj.points = sum(points/n.sim)) %>% arrange(desc(proj.points))
final.table <- final.table %>% left_join(lg.gd, by = "team")
final.table <- final.table %>% left_join(type1, by = "team")
final.table <- final.table %>% left_join(type2, by = "team")
final.table <- final.table %>% left_join(typex, by = "team")
final.table <- final.table %>% left_join(type3, by = "team")
final.table <- final.table %>% left_join(xgols, by = "team")
final.table[is.na(final.table)] <- 0
# Create trajectories
all.projs <- NA
for (i in 12:max(results$jornada)){
# Select jornadas
results.temp <- results %>% filter(jornada < (i+1))
results.other <- results %>% filter(jornada > (i))
results.other <- results.other %>% select(home, away, jornada)
schedule.temp <- schedule %>% select(-date)
schedule.temp <- rbind(schedule.temp, results.other)
# Model
weights <- weights_dc(results.temp$date, xi=xi.set)
gm_res <- goalmodel(goals1 = results.temp$home.score, goals2 = results.temp$away.score,
team1 = results.temp$home, team2=results.temp$away, weights = weights, rs=TRUE)
predictions.temp <- predict_result(gm_res, team1=schedule.temp$home, team2=schedule.temp$away, return_df = TRUE)
# Current Table
table <- results.temp
table <- mutate(table, home.points = ifelse(home.score > away.score, 3,
ifelse(home.score == away.score, 1, 0)))
table <- mutate(table, away.points = ifelse(home.score < away.score, 3,
ifelse(home.score == away.score, 1, 0)))
table.home <- table %>% group_by(home) %>%
summarize(points = sum(home.points))
table.away <- table %>% group_by(away) %>%
summarize(points = sum(away.points))
colnames(table.home)[1] <- 'team'
colnames(table.away)[1] <- 'team'
table.all <- rbind(table.home, table.away)
table.all <- table.all %>% group_by(team) %>%
summarize(points = sum(points)) %>% ungroup()
# Predicted Points
predictions.temp$home.points <- (predictions.temp$p1 * 3) + predictions.temp$pd
predictions.temp$away.points <- (predictions.temp$p2 * 3) + predictions.temp$pd
pred.home <- predictions.temp %>% group_by(team1) %>%
summarize(points = sum(home.points))
pred.away <- predictions.temp %>% group_by(team2) %>%
summarize(points = sum(away.points))
colnames(pred.home)[1] <- 'team'
colnames(pred.away)[1] <- 'team'
pred.all <- rbind(pred.home, pred.away)
pred.all <- pred.all %>% group_by(team) %>%
summarize(points = sum(points))
# Full Projection
proj <- rbind(pred.all, table.all)
proj <- proj %>% group_by(team) %>%
summarize(points = sum(points))
proj$round <- i
all.projs <- rbind(all.projs, proj)
status <- percent((i-12)/(max(results$jornada)-12))
print(paste0("Trajectories: ",status))
}
all.projs <- all.projs[complete.cases(all.projs), ]
## Add level to second trajectory
all.projs$type <- "team"
all.projs$league <- lg.code
# Type 1
level <- as.numeric((final.table[lg.type1,2] + final.table[(lg.type1+1),2])/2)
team <- rep(lg.type1name, times = (max(all.projs$round)-11))
points <- rep(level, times = (max(all.projs$round)-11))
round <- 12:max(all.projs$round)
league <- lg.code
type <- "level"
level <- cbind.data.frame(team, points, round, league, type)
all.projs <- rbind(all.projs,level)
# Type 2
level <- as.numeric((final.table[lg.type2,2] + final.table[(lg.type2-1),2])/2)
team <- rep(lg.type2name, times = (max(all.projs$round)-11))
points <- rep(level, times = (max(all.projs$round)-11))
round <- 12:max(all.projs$round)
league <- lg.code
type <- "level"
level <- cbind.data.frame(team, points, round, league, type)
all.projs <- rbind(all.projs,level)
# Type 3
level <- as.numeric((final.table[lg.type3,2] + final.table[(lg.type3+1),2])/2)
team <- "Descens"
points <- rep(level, times = (max(all.projs$round)-11))
round <- 12:max(all.projs$round)
league <- lg.code
type <- "level"
level <- cbind.data.frame(team, points, round, league, type)
all.projs <- rbind(all.projs,level)
# Type X
level <- as.numeric((final.table[6,2] + final.table[7,2])/2)
team <- "Europa"
points <- rep(level, times = (max(all.projs$round)-11))
round <- 12:max(all.projs$round)
league <- lg.code
type <- "typex"
level <- cbind.data.frame(team, points, round, league, type)
all.projs <- rbind(all.projs,level)
# Add jornada back to predictions, scale
games$key <- paste0(games$home, games$away)
predictions$key <- paste0(predictions.temp$team1, predictions.temp$team2)
predictions <- predictions %>% left_join(games, by = "key") %>% select(jornada, team1, p1, pd, p2, team2)
predictions$p1 <- predictions$p1*100
predictions$pd <- predictions$pd*100
predictions$p2 <- predictions$p2*100
# Add league code
final.table$league <- lg.code
predictions$league <- lg.code
# Add to other leagues
aa.final.table <- rbind(aa.final.table, final.table)
aa.predictions <- rbind(aa.predictions, predictions)
aa.all.projs <- rbind(aa.all.projs, all.projs)
}
# Remove NA rows
aa.final.table <- aa.final.table[2:nrow(aa.final.table),]
aa.predictions <- aa.predictions[2:nrow(aa.predictions),]
aa.all.projs <- aa.all.projs[2:nrow(aa.all.projs),]
# Write CSVs
write_csv(aa.final.table, "data_tables.csv")
write_csv(aa.predictions, "data_games.csv")
write_csv(aa.all.projs, "data_trajectories.csv")
### Make website pages
# League pages
teamnames <- read_csv("~/Google Drive/Futbol/teamlist.csv")
for (i in 1:nrow(leagues)){
# Basics
lg.name <- as.character(leagues[i,1])
lg.code <- as.character(leagues[i,2])
lg.type1 <- as.character(leagues[i,7])
lg.type2 <- as.character(leagues[i,8])
lg.stub <- tolower(gsub("[[:punct:]]", "", lg.name))
lg.stub <- gsub("[[:space:]]", "-", lg.stub)
# Find Campió Projectat
campio <- aa.final.table %>% filter(league == lg.code) %>% arrange(desc(proj.points))
campio <- campio[1,1]
campio <- campio %>% left_join(teamnames, by = "team")
campio <- as.character(campio[1,2])
# Write page
dashes <- '---'
l1 <- 'date: "2020-06-17"'
l2 <- 'image:'
l3 <- '  preview_only: true'
l4 <- paste0('summary: Campió Projectat, ',campio)
l5 <- 'tags:'
l6 <- '  - Estiu 2020'
l7 <- paste0('title: ', lg.name)
l8 <- '### Projecció de la classificació final'
l9 <- paste0(" | [Trajectòria dels equips](/competicions/",lg.stub,"-trajectoria/) |")
br <- '<br>'
start <- '```{r echo=F,warning=FALSE,message=FALSE}'
l10 <- 'library(tidyverse)'
l11 <- 'library(kableExtra)'
l12 <- 'teamnames <- read_csv("~/Google Drive/Futbol/teamlist.csv")'
l13 <- 'table <- read_csv("~/Google Drive/Futbol/data_tables.csv")'
l14 <- paste0("table <- table %>% filter(league == '", lg.code, "')")
l15 <- 'table <- teamnames %>% left_join(table, by = "team") %>% arrange(desc(proj.points))'
l16 <- "table <- table[complete.cases(table),]"
l17 <- 'table$linkteam <- iconv(table$fullname,to="ASCII//TRANSLIT")'
l18 <- 'table$linkteam <- tolower(gsub("[[:punct:]]", "", table$linkteam))'
l19 <- 'table$linkteam <- gsub("[[:space:]]", "-", table$linkteam)'
l20 <- 'table$team <- paste0("[", table$shortname, "](/clubs/", table$linkteam,"-",table$league,")")'
l21 <- 'table <- table %>% select(-shortname,-fullname,-league,-linkteam, -typex)'
l21x <- 'table <- table %>% select(-shortname,-fullname,-league,-linkteam)'
l22 <- paste0("kable(table, digits = 1, align = 'lccccccc', row.names = FALSE, col.names = c('Club', 'Punts', 'GD', '", lg.type1, "', '", lg.type2,"', 'Descens', 'Favor', 'Contra')) %>% add_header_above(c('Projecció de la Classificació' = 1, 'Final' = 2, 'Probabilitat (%)' = 3, 'xGols' = 2)) %>% column_spec(1, bold = T) %>% column_spec(3, border_right = T) %>% column_spec(6, border_right = T)")
l22x <- paste0("kable(table, digits = 1, align = 'lcccccccc', row.names = FALSE, col.names = c('Club', 'Punts', 'GD', '", lg.type1, "', '", lg.type2,"', 'Europa', 'Descens', 'Favor', 'Contra')) %>% add_header_above(c('Projecció de la Classificació' = 1, 'Final' = 2, 'Probabilitat (%)' = 4, 'xGols' = 2)) %>% column_spec(1, bold = T) %>% column_spec(3, border_right = T) %>% column_spec(7, border_right = T)")
end <- "```"
teamfolder <- paste0("~/Google Drive/Futbol/futstatcat/content/competicions/",lg.stub)
setwd(teamfolder)
writeLines(c(dashes,l1,l2,l3,l4,l5,l6,l7,dashes,l9,br,br,start,l10,l11,l12,l13,l14,l15,l16,l17,l18,l19,l20,l21,l22,end), "index.rmd")
if (lg.code == "primera"){writeLines(c(dashes,l1,l2,l3,l4,l5,l6,l7,dashes,l9,br,br,start,l10,l11,l12,l13,l14,l15,l16,l17,l18,l19,l20,l21x,l22x,end), "index.rmd")}
}
# Team pages
clubs <- aa.final.table %>% select(team, league)
clubs <- clubs %>% left_join(teamnames, by = "team")
lgs <- leagues %>% select(name,code)
names(lgs) <- c("lg.name","league")
clubs <- clubs %>% left_join(lgs, by = "league")
for (i in 1:nrow(clubs)){
club <- as.character(clubs[i,1])
lg.code <- as.character(clubs[i,2])
lg.name <- as.character(clubs[i,5])
club.name <- as.character(clubs[i,4])
l1 <- 'date: "2020-06-17"'
l2 <- paste0("title: '", club.name, "'")
l3 <- paste0("subtitle: '", lg.name,"'")
l4 <- paste0("summary: '", lg.name,"'")
l5 <- '### Trajectòria'
start2 <- "```{r fig.width=8, fig.height=5, echo=F,warning=FALSE,message=FALSE}"
l6 <- 'library(tidyverse)'
l7 <- 'library(ggplot2)'
l8 <- 'd <- read_csv("~/Google Drive/Futbol/data_trajectories.csv")'
l9 <- paste0("d1 <- d %>% filter(team == '",club,"')")
l10 <- 'd1$team <- "Punts del club"'
l11 <- paste0("d2 <- d %>% filter(league == '",lg.code,"' & type == 'level')")
l11x <- paste0("d2 <- d %>% filter(league == '",lg.code,"' & (type == 'level' | type == 'typex'))")
l12 <- 'd <- rbind(d1,d2)'
l13 <- 'p <- ggplot(data=d) + geom_line(aes(round,points, color = team), size = 1.5)'
l14 <- 'p + theme_minimal() + labs(color = "Projeccions", x = "Jornada", y = "Punts Projectats")'
space <- " "
l15 <- '### Pròxims partits'
l16 <- 'library(kableExtra)'
l17 <- 'teamnames <- read_csv("~/Google Drive/Futbol/teamlist.csv") %>% select(-fullname)'
l18 <- 'games <- read_csv("~/Google Drive/Futbol/data_games.csv")'
l19 <- paste0("games <- games %>% filter(team1 == '",club,"' | team2 == '",club,"')")
l20 <- 'names(teamnames) <- c("home", "team1")'
l21 <- 'games <- games %>% left_join(teamnames, by = "team1")'
l22 <- 'names(teamnames) <- c("away", "team2")'
l23 <- 'games <- games %>% left_join(teamnames, by = "team2") %>% select(jornada, home, p1, pd, p2, away)'
l24 <- 'kable(games, digits = 1, align = "c", row.names = FALSE, col.names = c("Jornada", "Equip", "Guanyar", "Empatar", "Guanyar", "Equip")) %>% add_header_above(c("2019-20" = 1, "Local" = 2, "(%)" = 1, "Visitant" = 2)) %>% column_spec(2, bold = T) %>% column_spec(6, bold = T)'
filename <- iconv(club.name,to="ASCII//TRANSLIT")
filename <- tolower(gsub("[[:punct:]]", "", filename))
filename <- paste0(filename,"-",lg.code,".rmd")
filename <- gsub("[[:space:]]", "-", filename)
setwd("~/Google Drive/Futbol/futstatcat/content/clubs")
writeLines(c(dashes,l1,l2,l3,l4,dashes,l5,start2,l6,l7,l8,l9,l10,l11,l12,l13,l14,end,space,l15,start,l16,l17,l18,l19,l20,l21,l22,l23,l24,end), filename)
if (lg.code == "primera"){writeLines(c(dashes,l1,l2,l3,l4,dashes,l5,start2,l6,l7,l8,l9,l10,l11x,l12,l13,l14,end,space,l15,start,l16,l17,l18,l19,l20,l21,l22,l23,l24,end), filename)}
}
# Update trajectory pages
render("~/Google Drive/Futbol/futstatcat/content/competicions/la-liga-trajectoria/index.rmd")
render("~/Google Drive/Futbol/futstatcat/content/competicions/segona-a-trajectoria/index.rmd")
# Start site
setwd("~/Google Drive/Futbol/futstatcat")
serve_site()
stop_server()
library(blogdown)
library(rmarkdown)
library(tidyverse)
library(rvest)
library(elo)
library(scales)
setwd("~/Google Drive/KBO")
## Scrape 2020 Schedule and Results
links <- read_csv("mykboweeks.csv")
links <- links$url
all.results <- NA
all.schedule <- NA
for (i in links){
print(i)
url <- i
week <- substring(url, first = 38)
d <- read_html(url) %>% html_table() %>% as.data.frame() %>% select(-X2, -X4)
d <- d[2:(nrow(d)-1),]
d <- d %>% filter(str_detect(X1, "2020") == F)
d <- d %>% separate(X1, c("away1", "away2"))
d <- d %>% separate(X5, c("home1", "home2"))
d <- d %>% separate(X3, c("A.Score", "H.Score"))
d$Away <- paste(d$away1, d$away2)
d$Home <- paste(d$home1, d$home2)
d$week <- as.Date(week)
d$Year <- 2020
d$addday <- rep(0:6, each = 5, length.out = nrow(d))
d$Date <- as.Date(d$week + d$addday)
results <- d %>% filter(!str_detect(H.Score, "0am") & !str_detect(A.Score, "Canceled")) %>% select(Date, Home, Away, H.Score, A.Score, Year)
schedule <- d %>% filter(str_detect(H.Score, "0am")) %>% select(Home, Away, Date, Year)
all.results <- rbind(all.results, results)
if (nrow(schedule) > 0) {
all.schedule <- rbind(all.schedule, schedule)
}
}
all.results <- all.results[2:nrow(all.results),]
all.schedule <- all.schedule[2:nrow(all.schedule),]
## Tally Current Win Totals
all.results$H.Score <- as.numeric(all.results$H.Score)
all.results$A.Score <- as.numeric(all.results$A.Score)
all.results <- mutate(all.results, H.Win = ifelse(H.Score > A.Score, 1,
ifelse(H.Score == A.Score, .5, 0)))
all.results <- mutate(all.results, A.Win = ifelse(H.Score < A.Score, 1,
ifelse(H.Score == A.Score, .5, 0)))
h.wins <- all.results %>% select(Home, H.Win)
names(h.wins) <- c("Winner", "n")
a.wins <- all.results %>% select(Away, A.Win)
names(a.wins) <- c("Winner", "n")
wins <- rbind(h.wins,a.wins)
wins <- wins %>% group_by(Winner) %>% summarize(n = sum(n))
all.results <- all.results %>% select(-H.Win, -A.Win)
## Read In Historical Results
kbohistory <- read_csv("kboresults.csv")
kbohistory$Date <- ISOdate(kbohistory$Year, kbohistory$Month, kbohistory$Day)
kbohistory <- kbohistory %>% select(Date, Home, Away, H.Score, A.Score, Year)
all.history <- rbind(kbohistory, all.results)
all.history <- all.history[order(all.history$Date),]
all.history$H.Score <- as.double(all.history$H.Score)
all.history$A.Score <- as.double(all.history$A.Score)
## Run Elo
elo <- elo.run(score(H.Score, A.Score) ~ adjust(Home, 24) + Away + regress(Year, 1500, 0.5) + k(4*(abs(H.Score - A.Score)^(1/4))), data = all.history)
all.history$H.Elo <- elo[[1]][,7]
all.history$A.Elo <- elo[[1]][,8]
## Create Elo History Table
home <- all.history %>% select(Date, Home, H.Elo)
away <- all.history %>% select(Date, Away, A.Elo)
cols <- c("Date", "Team", "Elo")
colnames(home) <- cols
colnames(away) <- cols
elo.history <- rbind(home,away)
elo.history$Elo <- round(elo.history$Elo, digits = 0)
## Current Elos
current.elos <- elo.history %>%
group_by(Team) %>%
arrange(desc(Date)) %>%
slice(1) %>% select(-Date) %>%
arrange(desc(Elo))
current.elos$Rank <- 1:10
write_csv(current.elos, "currentelos.csv")
## Ten Team Era for History Page
tenteam <- elo.history %>% filter(Date > ISOdate(2013,1,1))
write_csv(tenteam,"elohistory.csv")
## Simulations
nsim <- 100000
all.schedule$Prediction <- predict(elo, newdata = all.schedule)
all.schedule <- data.frame(all.schedule, Round = rep(1:nsim, each = nrow(all.schedule)))
all.schedule$Sim <- runif((nrow(all.schedule)),0,1)
all.schedule <- mutate(all.schedule, H.Win = ifelse(Sim < Prediction, 1, 0))
all.schedule <- mutate(all.schedule, Winner = ifelse(H.Win == 1, as.character(Home), as.character(Away)))
standings <- all.schedule %>% group_by(Winner, Round) %>% count(wt = n())
standings <- standings %>% left_join(wins, by = "Winner")
standings$n.y[is.na(standings$n.y)] <- 0
standings$n <- standings$n.x + standings$n.y
standings$tiebreak <- runif((nrow(standings)),0,1)
standings <- standings %>% arrange(tiebreak) %>% arrange(desc(n)) %>% arrange(Round)
standings$Rank <- rep(1:10, max(standings$Round))
pred.1 <- standings %>% filter(Rank == 1) %>% group_by(Winner) %>% count(wt = n())
pred.1$Pct <- (pred.1$n/nsim)
colnames(pred.1) <- c("Winner", "n", "First")
pred.2 <- standings %>% filter(Rank == 2) %>% group_by(Winner) %>% count(wt = n())
pred.2$Pct <- (pred.2$n/nsim)
colnames(pred.2) <- c("Winner", "n", "Second")
pred.3 <- standings %>% filter(Rank == 3) %>% group_by(Winner) %>% count(wt = n())
pred.3$Pct <- (pred.3$n/nsim)
colnames(pred.3) <- c("Winner", "n", "Third")
pred.4 <- standings %>% filter(Rank == 4) %>% group_by(Winner) %>% count(wt = n())
pred.4$Pct <- (pred.4$n/nsim)
colnames(pred.4) <- c("Winner", "n", "Fourth")
pred.5 <- standings %>% filter(Rank == 5) %>% group_by(Winner) %>% count(wt = n())
pred.5$Pct <- (pred.5$n/nsim)
colnames(pred.5) <- c("Winner", "n", "Fifth")
pred.6 <- standings %>% filter(Rank > 5) %>% group_by(Winner) %>% count(wt = n())
pred.6$Pct <- (pred.6$n/nsim)
colnames(pred.6) <- c("Winner", "n", "Out")
predictions <- ungroup(as.data.frame(standings$Winner[1:10]))
colnames(predictions) <- "Winner"
predictions <- pred.1 %>% select(-n) %>% right_join(predictions, by = "Winner")
predictions <- pred.2 %>% select(-n) %>% right_join(predictions, by = "Winner")
predictions <- pred.3 %>% select(-n) %>% right_join(predictions, by = "Winner")
predictions <- pred.4 %>% select(-n) %>% right_join(predictions, by = "Winner")
predictions <- pred.5 %>% select(-n) %>% right_join(predictions, by = "Winner")
predictions <- pred.6 %>% select(-n) %>% right_join(predictions, by = "Winner")
predictions$Team <- predictions$Winner
predictions <- predictions %>% left_join(current.elos, by = "Team")
predictions <- predictions %>% ungroup() %>% select(-Winner)
predictions <- predictions %>%
mutate(First = percent(First, 1)) %>%
mutate(Second = percent(Second, 1)) %>%
mutate(Third = percent(Third, 1)) %>%
mutate(Fourth = percent(Fourth, 1)) %>%
mutate(Fifth = percent(Fifth, 1)) %>%
mutate(Out = percent(Out, 1))
predictions <- predictions %>% select(Rank, Team, Elo, First, Second, Third, Fourth, Fifth, Out)
predictions[is.na(predictions)] <- "0%"
write_csv(predictions, "predictions.csv")
## Homepage image
setwd("~/Google Drive/KBO/kbofancystats/static/img")
tenteam <- read_csv("~/Google Drive/KBO/elohistory.csv")
tenteam <- tenteam %>% subset(Date > ISOdate(2020,5,4))
tenteam$Team <- as.factor(tenteam$Team)
rank <- read_csv("~/Google Drive/KBO/currentelos.csv")
rank$Team2 <- paste0(rank$Team, " (",rank$Elo,")")
levels <- rank$Team2
tenteam <- tenteam %>% left_join(rank, by = "Team")
tenteam$Team2 <- as.factor(tenteam$Team2)
tenteam$Team2 <- factor(tenteam$Team2, levels = levels)
plot <- ggplot() + geom_line(data = tenteam, aes(Date, Elo.x, color = Team2)) + theme_minimal() + labs(x = "", y = "Elo", color = "")
ggsave("elo.png", width = 8, height = 3)
## Render Elo Pages
render("~/Google Drive/KBO/kbofancystats/content/elo.Rmd")
render("~/Google Drive/KBO/kbofancystats/content/elo2020.Rmd")
render("~/Google Drive/KBO/kbofancystats/content/elohistory.Rmd")
setwd("~/Google Drive/KBO/kbofancystats")
serve_site()
