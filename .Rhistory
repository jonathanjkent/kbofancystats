plot(bcn2["bt_vs_tweets"], breaks = c(-.4,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15,.4))
plot(madrid2["bt_vs_tweets"], breaks = c(-.4,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15,.4))
# City maps
plot(bcn2["bt_vs_pop"], breaks = c(-.4,-.3,-.2,-.1,0,.1,.2,.3,.4))
plot(bcn2["bt_vs_pop"], breaks = c(-.4,-.3,-.2,-.1,0,.1,.2,.3,.4))
plot(madrid2["bt_vs_pop"], breaks = c(-.4,-.3,-.2,-.1,0,.1,.2,.3,.4))
plot(bcn2["bt_vs_tweets"], breaks = c(-.4,-.3,-.2,-.1,0,.1,.2,.3,.4))
plot(madrid2["bt_vs_tweets"], breaks = c(-.4,-.3,-.2,-.1,0,.1,.2,.3,.4))
head(bcn2 %>% arrange(desc(bt_vs_tweets)))
head(madrid2 %>% arrange(desc(bt_vs_tweets)))
head(madrid2 %>% arrange(desc(bt_vs_pop)))
plot(bcn2["bt_vs_pop"], breaks = c(-.4,-.3,-.2,-.1,0,.1,.2))
plot(madrid2["bt_vs_pop"], breaks = c(-.4,-.3,-.2,-.1,0,.1,.2))
plot(bcn2["bt_vs_tweets"], breaks = c(-.4,-.3,-.2,-.1,0,.1,.2))
plot(madrid2["bt_vs_tweets"], breaks = c(-.4,-.3,-.2,-.1,0,.1,.2))
# City maps
plot(bcn2["bt_vs_pop"], breaks = c(-.4,-.35,-.3,-.25,-.2,-.15,-.1,-.05,0,.05,.1,.15))
plot(bcn2["bt_vs_pop"], breaks = c(-.4,-.35,-.3,-.25,-.2,-.15,-.1,-.05,0,.05,.1,.15))
plot(madrid2["bt_vs_pop"], breaks = c(-.4,-.35,-.3,-.25,-.2,-.15,-.1,-.05,0,.05,.1,.15))
plot(bcn2["bt_vs_tweets"], breaks = c(-.4,-.35,-.3,-.25,-.2,-.15,-.1,-.05,0,.05,.1,.15))
plot(madrid2["bt_vs_tweets"], breaks = c(-.4,-.35,-.3,-.25,-.2,-.15,-.1,-.05,0,.05,.1,.15))
plot(bcn2["bt_vs_pop"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15)
plot(madrid2["bt_vs_pop"], breaks = c(-.4,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15)
plot(bcn2["bt_vs_tweets"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15)
plot(madrid2["bt_vs_tweets"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15)
plot(bcn2["bt_vs_pop"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(madrid2["bt_vs_pop"], breaks = c(-.4,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(bcn2["bt_vs_tweets"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(madrid2["bt_vs_tweets"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(bcn2["bt_vs_tweets"], breaks = c(-.4,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
districts %>% arrange(bt_vs_tweets)
municipalities %>% arrange(bt_vs_tweets)
madrid <- st_make_valid(districts) %>% filter(NCA == "Comunidad de Madrid" | NMUN == "Segovia") %>% group_by(NMUN) %>% summarise_at(vars(bt_count, tw_count), sum)
madrid$bt_pct <- madrid$bt_count/sum(madrid$bt_count)
madrid$tw_pct <- madrid$tw_count/sum(madrid$tw_count)
madrid$bt_vs_tweets <- madrid$bt_pct - madrid$tw_pct
munidata <- read_csv("~/research/munipopincome.csv")
madrid <- madrid %>% left_join(munidata, by = "NMUN")
madrid$pop_pct <- madrid$population/sum(madrid$population, na.rm = T)
madrid$bt_vs_pop <- madrid$bt_pct - madrid$pop_pct
madrid %>% arrange(desc(bt_count))
madrid2 <- madrid %>% filter(tw_count > 1 & bt_count > 1 & population > 0)
plot(madrid2["bt_vs_tweets"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
sum(districts$tw_count)
summary(tweets)
max(tweets$parsed_created_at)
min(tweets$parsed_created_at)
# KBO Fancy Stats
source("~/Google Drive/KBO/2020elo.R")
library(tidyverse)
library(arrow)
first <- 500
last <- 500
start <- Sys.time()
for (i in 0:50){
filestart <- Sys.time()
file <- paste0("/Volumes/research/data_run2/chunk_",i,".parquet")
raw <- read_parquet(file) %>%
select(created_at, user.id, coordinates.coordinates) %>%
filter(map_lgl(coordinates.coordinates, ~ !is.null(.)))
raw <- suppressMessages(unnest_wider(raw, coordinates.coordinates))
names(raw) <- c("timestamp","user","lon","lat")
csv_name <- paste0("/Volumes/research/processed_tweeets/chunk_",i,"_pro.csv")
write_csv(raw, csv_name)
raw <- raw %>%
filter(lon > -9.39288367353 & lon < 3.03948408368) %>%
filter(lat > 35.946850084 & lat < 43.7483377142)
spain_name <- paste0("~/research/spain_tweets/spain_",i,".csv")
write_csv(raw, spain_name)
fileend <- Sys.time()
print(paste0("Chunk ",i," Completed | ",(i-first)/(last-first)*100,"% of Set"))
print(paste0("Date range: ", min(raw$created_at), " to ", max(raw$created_at)))
print(paste0("Processing ",fileend-filestart))
}
end <- Sys.time()
end-start
fileend-filestart
min(raw$created_at)
max(raw$created_at)
fileend-filestart
(fileend-filestart)
library(tidyverse)
library(arrow)
first <- 500
last <- 500
start <- Sys.time()
for (i in first:last){
filestart <- Sys.time()
file <- paste0("/Volumes/research/data_run2/chunk_",i,".parquet")
raw <- read_parquet(file) %>%
select(created_at, user.id, coordinates.coordinates) %>%
filter(map_lgl(coordinates.coordinates, ~ !is.null(.)))
raw <- suppressMessages(unnest_wider(raw, coordinates.coordinates))
names(raw) <- c("timestamp","user","lon","lat")
csv_name <- paste0("/Volumes/research/processed_tweeets/chunk_",i,"_pro.csv")
write_csv(raw, csv_name)
raw <- raw %>%
filter(lon > -9.39288367353 & lon < 3.03948408368) %>%
filter(lat > 35.946850084 & lat < 43.7483377142)
spain_name <- paste0("~/research/spain_tweets/spain_",i,".csv")
write_csv(raw, spain_name)
fileend <- Sys.time()
print(paste0("Chunk ",i," Completed | ",(i-first)/(last-first)*100,"% of Set"))
print(paste0("Date range: ", min(raw$created_at), " to ", max(raw$created_at)))
(fileend-filestart)
}
end <- Sys.time()
end-start
(min(raw$created_at))
print("to")
(max(raw$created_at))
(fileend-filestart)
min(raw$created_at)
raw
print(paste0("Date range: ", min(raw$timestamp), " to ", max(raw$timestamp)))
library(tidyverse)
library(arrow)
first <- 501
last <- 700
start <- Sys.time()
for (i in first:last){
filestart <- Sys.time()
file <- paste0("/Volumes/research/data_run2/chunk_",i,".parquet")
raw <- read_parquet(file) %>%
select(created_at, user.id, coordinates.coordinates) %>%
filter(map_lgl(coordinates.coordinates, ~ !is.null(.)))
raw <- suppressMessages(unnest_wider(raw, coordinates.coordinates))
names(raw) <- c("timestamp","user","lon","lat")
csv_name <- paste0("/Volumes/research/processed_tweeets/chunk_",i,"_pro.csv")
write_csv(raw, csv_name)
raw <- raw %>%
filter(lon > -9.39288367353 & lon < 3.03948408368) %>%
filter(lat > 35.946850084 & lat < 43.7483377142)
spain_name <- paste0("~/research/spain_tweets/spain_",i,".csv")
write_csv(raw, spain_name)
fileend <- Sys.time()
print(paste0("Chunk ",i," Completed | ",(i-first)/(last-first)*100,"% of Set"))
print(paste0("Date range: ", min(raw$timestamp), " to ", max(raw$timestamp)))
(fileend-filestart)
}
end <- Sys.time()
end-start
d.all <- NA
for (i in 500:657){
file <- paste0("~/research/spain_tweets/spain_",i,".csv")
d <- read_csv(file)
d.all <- rbind(d.all,d)
}
write.csv(d.all, "~/research/tweets_500_657.csv")
tweets <- d.all
library(tidyverse)
library(sf)
# Load background track data
bgtracks <- readRDS("~/research/data/exp_pro/user_locations_small_cell.rds")
# Randomize location within sampling cell
bgtracks$fake_lon <- bgtracks$masked_lon + runif(nrow(bgtracks), 0, .025)
bgtracks$fake_lat <- bgtracks$masked_lat + runif(nrow(bgtracks), 0, .025)
# Convert points to SF objects
bgtracks <- bgtracks %>% st_as_sf(coords = c("fake_lon", "fake_lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
# Load districts as SF objects
districts <- st_read("~/research/shapefiles/SECC_CPV_E_20111101_01_R_INE.shp")
districts <- st_transform(districts, "+proj=longlat +ellps=WGS84 +datum=WGS84")
# Add background track count to district data
districts$bt_count <- lengths(st_intersects(districts, bgtracks))
# Load tweets, add tweet count to district data
#tweets <- readRDS("~/research/sfm_export_b4f78871b13d4773a0bcde6cb2c348db.rds")
tweets <- tweets %>% st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
summary(d.all)
tweets[2:nrow(tweets),]
tweets <- tweets[2:nrow(tweets),]
# Load tweets, add tweet count to district data
#tweets <- readRDS("~/research/sfm_export_b4f78871b13d4773a0bcde6cb2c348db.rds")
tweets <- tweets %>% st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
districts$tw_count <- lengths(st_intersects(districts, tweets))
# Background tracks and tweets as proportion
districts$bt_pct <- districts$bt_count/sum(districts$bt_count)
districts$tw_pct <- districts$tw_count/sum(districts$tw_count)
districts$bt_vs_tweets <- districts$bt_pct - districts$tw_pct
## Collapse by autonomous community and municipality
# CCAA
communities <- st_make_valid(districts) %>% group_by(NCA) %>% summarise_at(vars(bt_count, tw_count), sum)
communities <- communities %>% filter(NCA != "Pais Vasco")
communities$bt_pct <- communities$bt_count/sum(communities$bt_count)
communities$tw_pct <- communities$tw_count/sum(communities$tw_count)
communities$bt_vs_tweets <- communities$bt_pct -communities$tw_pct
ccaadata <- read_csv("~/research/ccaapopincome.csv")
communities <- communities %>% left_join(ccaadata, by = "NCA")
communities$pop_pct <- communities$population/sum(communities$population)
communities$bt_vs_pop <- communities$bt_pct - communities$pop_pct
# CCAA Analysis: no added value using tweets, no relationship w/ income
#cor(communities$more_pop, communities$more_tweets)
#summary(lm(more_tweets ~ income, data = communities %>% filter(bt_count > 20)))
#ggplot(communities %>% filter(bt_count > 20)) + geom_point(aes(income, more_tweets)) + geom_smooth(aes(income, more_tweets), method = 'lm')
# Municipalities
municipalities <- st_make_valid(districts) %>% group_by(NMUN) %>% summarise_at(vars(bt_count, tw_count), sum)
municipalities$bt_pct <- municipalities$bt_count/sum(municipalities$bt_count)
municipalities$tw_pct <- municipalities$tw_count/sum(municipalities$tw_count)
municipalities$bt_vs_tweets <- municipalities$bt_pct - municipalities$tw_pct
#st_geometry(municipalities) <- NULL
munidata <- read_csv("~/research/munipopincome.csv")
municipalities <- municipalities %>% left_join(munidata, by = "NMUN")
municipalities$pop_pct <- municipalities$population/sum(municipalities$population, na.rm = T)
municipalities$bt_vs_pop <- municipalities$bt_pct - municipalities$pop_pct
# Muni Analysis: Pop & tweets not as closely correlated, still no relation w/ income
#cor(municipalities$more_pop, municipalities$more_tweets, use = "complete.obs")
#summary(lm(more_pop ~ more_tweets, data = municipalities %>% filter(bt_count > 0)))
#summary(lm(bt_count ~ income + pop_pct, data = municipalities %>% filter(bt_count > 0)))
#ggplot(municipalities %>% filter(bt_count > 0 & more_tweets < .02 & more_tweets > -.02)) + geom_point(aes(income, more_tweets)) + geom_smooth(aes(income, more_tweets), method = 'lm')
#ggplot(municipalities %>% filter(bt_count > 0 & bt_count < 1500)) + geom_point(aes(income, bt_count)) + geom_smooth(aes(income, bt_count), method = 'lm')
#ggplot(municipalities %>% filter(bt_count > 0 & more_tweets > -.02 & more_tweets < .02)) + geom_point(aes(more_tweets, more_pop)) + geom_smooth(aes(more_tweets, more_pop), method = 'lm')
#municipalities %>% arrange(desc(suburbs)) %>% select(NMUN,suburbs,tw_count)
###
# Load and add income data to district data
income <- read_csv("~/research/incomebybarri.csv") %>% select(-renta_persona)
population <- read_csv("~/research/popbybarri.csv")
population$CUSEC <- as.character(population$CUSEC)
income$renta_hogar <- as.numeric(income$renta_hogar)
names(income)[2] <- "income"
income <- income %>% separate(area, c("CUSEC"))
districts <- districts %>% left_join(income, by = "CUSEC")
districts <- districts %>% left_join(population, by = "CUSEC")
districts$pop_pct <- districts$population/sum(districts$population, na.rm = T)
districts$bt_vs_pop <- districts$bt_pct - districts$pop_pct
# Analysis: no relationship
#cor(districts$more_pop, districts$more_tweets, use = "complete.obs")
#summary(lm(more_tweets ~ renta_hogar, data = districts %>% filter(tw_count > 0 & bt_count > 0)))
#summary(lm(more_pop ~ renta_hogar, data = districts %>% filter(tw_count > 0 & bt_count > 0)))
#ggplot(districts %>% filter(tw_count > 0 & bt_count > 0)) + geom_point(aes(renta_hogar, more_tweets)) + #geom_smooth(aes(renta_hogar, more_tweets), method = 'lm')
# Simplify and save
#st_geometry(communities) <- NULL
#st_geometry(municipalities) <- NULL
#st_geometry(districts) <- NULL
#districts <- districts %>% select(CUSEC, NMUN, bt_count, tw_count, bt_pct, tw_pct, bt_vs_tweets, population, income, pop_pct, bt_vs_pop)
#write_csv(communities, "~/research/ccaa_datasimple.csv")
#write_csv(municipalities, "~/research/muni_datasimple.csv")
#write_csv(districts, "~/research/tract_datasimple.csv")
# Plots and Maps
ccaa <- communities %>% filter(NCA != "Canarias") %>% filter(NCA != "Ceuta") %>% filter(NCA != "Melilla")
plot(ccaa["bt_vs_tweets"])
plot(ccaa["bt_vs_pop"])
# Madrid
madrid <- st_make_valid(districts) %>% filter(NCA == "Comunidad de Madrid") %>% group_by(NMUN) %>% summarise_at(vars(bt_count, tw_count), sum)
madrid$bt_pct <- madrid$bt_count/sum(madrid$bt_count)
madrid$tw_pct <- madrid$tw_count/sum(madrid$tw_count)
madrid$bt_vs_tweets <- madrid$bt_pct - madrid$tw_pct
munidata <- read_csv("~/research/munipopincome.csv")
madrid <- madrid %>% left_join(munidata, by = "NMUN")
madrid$pop_pct <- madrid$population/sum(madrid$population, na.rm = T)
madrid$bt_vs_pop <- madrid$bt_pct - madrid$pop_pct
madrid %>% arrange(desc(bt_count))
madrid2 <- madrid %>% filter(tw_count > 1 & bt_count > 1 & population > 0)
# BCN
bcn <- st_make_valid(districts) %>% filter(NPRO == "Barcelona") %>% group_by(NMUN) %>% summarise_at(vars(bt_count, tw_count), sum)
bcn$bt_pct <- bcn$bt_count/sum(bcn$bt_count)
bcn$tw_pct <- bcn$tw_count/sum(bcn$tw_count)
bcn$bt_vs_tweets <- bcn$bt_pct - bcn$tw_pct
munidata <- read_csv("~/research/munipopincome.csv")
bcn <- bcn %>% left_join(munidata, by = "NMUN")
bcn$pop_pct <- bcn$population/sum(bcn$population, na.rm = T)
bcn$bt_vs_pop <- bcn$bt_pct - bcn$pop_pct
bcn %>% arrange(desc(bt_count))
bcn2 <- bcn %>% filter(tw_count > 1 & bt_count > 1 & population > 0)
# City maps
plot(bcn2["bt_vs_pop"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(madrid2["bt_vs_pop"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(bcn2["bt_vs_tweets"], breaks = c(-.4,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(madrid2["bt_vs_tweets"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
View(bcn2)
ggplot(districts %>% filter(tw_count > 0 & bt_count > 0)) + geom_point(aes(renta_hogar, more_tweets)) + geom_smooth(aes(renta_hogar, more_tweets), method = 'lm')
names(districts)
ggplot(districts %>% filter(tw_count > 0 & bt_count > 0)) + geom_point(aes(income, bt_vs_tweets)) + geom_smooth(aes(income, bt_vs_tweets), method = 'lm')
# Analysis: no relationship
#cor(districts$more_pop, districts$more_tweets, use = "complete.obs")
summary(lm(bt_vs_tweets ~ income, data = districts %>% filter(tw_count > 0 & bt_count > 0)))
# Analysis: no relationship
#cor(districts$more_pop, districts$more_tweets, use = "complete.obs")
summary(lm(bt_vs_pop ~ income, data = districts %>% filter(tw_count > 0 & bt_count > 0)))
ggplot(districts %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets > -.01)) + geom_point(aes(income, bt_vs_tweets)) + geom_smooth(aes(income, bt_vs_tweets), method = 'lm')
summary(districts$income)
print(fileend-filestart)
library(tidyverse)
library(arrow)
first <- 658
last <- 900
start <- Sys.time()
for (i in first:last){
filestart <- Sys.time()
file <- paste0("/Volumes/research/data_run2/chunk_",i,".parquet")
raw <- read_parquet(file) %>%
select(created_at, user.id, coordinates.coordinates) %>%
filter(map_lgl(coordinates.coordinates, ~ !is.null(.)))
raw <- suppressMessages(unnest_wider(raw, coordinates.coordinates))
names(raw) <- c("timestamp","user","lon","lat")
csv_name <- paste0("/Volumes/research/processed_tweeets/chunk_",i,"_pro.csv")
write_csv(raw, csv_name)
raw <- raw %>%
filter(lon > -9.39288367353 & lon < 3.03948408368) %>%
filter(lat > 35.946850084 & lat < 43.7483377142)
spain_name <- paste0("~/research/spain_tweets/spain_",i,".csv")
write_csv(raw, spain_name)
fileend <- Sys.time()
print(paste0("Chunk ",i," Completed | ",round((i-first)/(last-first)*100,1),"% of Set"))
print(paste0("Date range: ", min(raw$timestamp), " to ", max(raw$timestamp)))
print(fileend-filestart)
}
end <- Sys.time()
end-start
library(tidyverse)
tweets <- NA
for (i in 500:900){
file <- paste0("~/research/spain_tweets/spain_",i,".csv")
d <- read_csv(file)
tweets <- rbind(tweets,d)
}
tweets <- tweets[2:nrow(tweets),]
write.csv(tweets, "~/research/tweets_500_657.csv")
library(tidyverse)
library(sf)
# Load background track data
bgtracks <- readRDS("~/research/data/exp_pro/user_locations_small_cell.rds")
# Randomize location within sampling cell
bgtracks$fake_lon <- bgtracks$masked_lon + runif(nrow(bgtracks), 0, .025)
bgtracks$fake_lat <- bgtracks$masked_lat + runif(nrow(bgtracks), 0, .025)
# Convert points to SF objects
bgtracks <- bgtracks %>% st_as_sf(coords = c("fake_lon", "fake_lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
# Load districts as SF objects
districts <- st_read("~/research/shapefiles/SECC_CPV_E_20111101_01_R_INE.shp")
districts <- st_transform(districts, "+proj=longlat +ellps=WGS84 +datum=WGS84")
# Add background track count to district data
districts$bt_count <- lengths(st_intersects(districts, bgtracks))
# Load tweets, add tweet count to district data
#tweets <- readRDS("~/research/sfm_export_b4f78871b13d4773a0bcde6cb2c348db.rds")
tweets <- tweets %>% st_as_sf(coords = c("lon", "lat"), crs = "+proj=longlat +ellps=WGS84 +datum=WGS84")
districts$tw_count <- lengths(st_intersects(districts, tweets))
# Background tracks and tweets as proportion
districts$bt_pct <- districts$bt_count/sum(districts$bt_count)
districts$tw_pct <- districts$tw_count/sum(districts$tw_count)
districts$bt_vs_tweets <- districts$bt_pct - districts$tw_pct
## Collapse by autonomous community and municipality
# CCAA
communities <- st_make_valid(districts) %>% group_by(NCA) %>% summarise_at(vars(bt_count, tw_count), sum)
communities <- communities %>% filter(NCA != "Pais Vasco")
communities$bt_pct <- communities$bt_count/sum(communities$bt_count)
communities$tw_pct <- communities$tw_count/sum(communities$tw_count)
communities$bt_vs_tweets <- communities$bt_pct -communities$tw_pct
ccaadata <- read_csv("~/research/ccaapopincome.csv")
communities <- communities %>% left_join(ccaadata, by = "NCA")
communities$pop_pct <- communities$population/sum(communities$population)
communities$bt_vs_pop <- communities$bt_pct - communities$pop_pct
# CCAA Analysis: no added value using tweets, no relationship w/ income
#cor(communities$more_pop, communities$more_tweets)
#summary(lm(more_tweets ~ income, data = communities %>% filter(bt_count > 20)))
#ggplot(communities %>% filter(bt_count > 20)) + geom_point(aes(income, more_tweets)) + geom_smooth(aes(income, more_tweets), method = 'lm')
# Municipalities
municipalities <- st_make_valid(districts) %>% group_by(NMUN) %>% summarise_at(vars(bt_count, tw_count), sum)
municipalities$bt_pct <- municipalities$bt_count/sum(municipalities$bt_count)
municipalities$tw_pct <- municipalities$tw_count/sum(municipalities$tw_count)
municipalities$bt_vs_tweets <- municipalities$bt_pct - municipalities$tw_pct
#st_geometry(municipalities) <- NULL
munidata <- read_csv("~/research/munipopincome.csv")
municipalities <- municipalities %>% left_join(munidata, by = "NMUN")
municipalities$pop_pct <- municipalities$population/sum(municipalities$population, na.rm = T)
municipalities$bt_vs_pop <- municipalities$bt_pct - municipalities$pop_pct
# Muni Analysis: Pop & tweets not as closely correlated, still no relation w/ income
#cor(municipalities$more_pop, municipalities$more_tweets, use = "complete.obs")
#summary(lm(more_pop ~ more_tweets, data = municipalities %>% filter(bt_count > 0)))
#summary(lm(bt_count ~ income + pop_pct, data = municipalities %>% filter(bt_count > 0)))
#ggplot(municipalities %>% filter(bt_count > 0 & more_tweets < .02 & more_tweets > -.02)) + geom_point(aes(income, more_tweets)) + geom_smooth(aes(income, more_tweets), method = 'lm')
#ggplot(municipalities %>% filter(bt_count > 0 & bt_count < 1500)) + geom_point(aes(income, bt_count)) + geom_smooth(aes(income, bt_count), method = 'lm')
#ggplot(municipalities %>% filter(bt_count > 0 & more_tweets > -.02 & more_tweets < .02)) + geom_point(aes(more_tweets, more_pop)) + geom_smooth(aes(more_tweets, more_pop), method = 'lm')
#municipalities %>% arrange(desc(suburbs)) %>% select(NMUN,suburbs,tw_count)
###
# Load and add income data to district data
income <- read_csv("~/research/incomebybarri.csv") %>% select(-renta_persona)
population <- read_csv("~/research/popbybarri.csv")
population$CUSEC <- as.character(population$CUSEC)
income$renta_hogar <- as.numeric(income$renta_hogar)
names(income)[2] <- "income"
income <- income %>% separate(area, c("CUSEC"))
districts <- districts %>% left_join(income, by = "CUSEC")
districts <- districts %>% left_join(population, by = "CUSEC")
districts$pop_pct <- districts$population/sum(districts$population, na.rm = T)
districts$bt_vs_pop <- districts$bt_pct - districts$pop_pct
# Analysis: no relationship
#cor(districts$more_pop, districts$more_tweets, use = "complete.obs")
summary(lm(bt_vs_pop ~ income, data = districts %>% filter(tw_count > 0 & bt_count > 0)))
#summary(lm(more_pop ~ renta_hogar, data = districts %>% filter(tw_count > 0 & bt_count > 0)))
ggplot(districts %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets > -.01)) + geom_point(aes(income, bt_vs_tweets)) + geom_smooth(aes(income, bt_vs_tweets), method = 'lm')
# Simplify and save
#st_geometry(communities) <- NULL
#st_geometry(municipalities) <- NULL
#st_geometry(districts) <- NULL
#districts <- districts %>% select(CUSEC, NMUN, bt_count, tw_count, bt_pct, tw_pct, bt_vs_tweets, population, income, pop_pct, bt_vs_pop)
#write_csv(communities, "~/research/ccaa_datasimple.csv")
#write_csv(municipalities, "~/research/muni_datasimple.csv")
#write_csv(districts, "~/research/tract_datasimple.csv")
# Plots and Maps
ccaa <- communities %>% filter(NCA != "Canarias") %>% filter(NCA != "Ceuta") %>% filter(NCA != "Melilla")
plot(ccaa["bt_vs_tweets"])
plot(ccaa["bt_vs_pop"])
# Madrid
madrid <- st_make_valid(districts) %>% filter(NCA == "Comunidad de Madrid") %>% group_by(NMUN) %>% summarise_at(vars(bt_count, tw_count), sum)
madrid$bt_pct <- madrid$bt_count/sum(madrid$bt_count)
madrid$tw_pct <- madrid$tw_count/sum(madrid$tw_count)
madrid$bt_vs_tweets <- madrid$bt_pct - madrid$tw_pct
munidata <- read_csv("~/research/munipopincome.csv")
madrid <- madrid %>% left_join(munidata, by = "NMUN")
madrid$pop_pct <- madrid$population/sum(madrid$population, na.rm = T)
madrid$bt_vs_pop <- madrid$bt_pct - madrid$pop_pct
madrid %>% arrange(desc(bt_count))
madrid2 <- madrid %>% filter(tw_count > 1 & bt_count > 1 & population > 0)
# BCN
bcn <- st_make_valid(districts) %>% filter(NPRO == "Barcelona") %>% group_by(NMUN) %>% summarise_at(vars(bt_count, tw_count), sum)
bcn$bt_pct <- bcn$bt_count/sum(bcn$bt_count)
bcn$tw_pct <- bcn$tw_count/sum(bcn$tw_count)
bcn$bt_vs_tweets <- bcn$bt_pct - bcn$tw_pct
munidata <- read_csv("~/research/munipopincome.csv")
bcn <- bcn %>% left_join(munidata, by = "NMUN")
bcn$pop_pct <- bcn$population/sum(bcn$population, na.rm = T)
bcn$bt_vs_pop <- bcn$bt_pct - bcn$pop_pct
bcn %>% arrange(desc(bt_count))
bcn2 <- bcn %>% filter(tw_count > 1 & bt_count > 1 & population > 0)
# City maps
plot(bcn2["bt_vs_pop"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(madrid2["bt_vs_pop"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(bcn2["bt_vs_tweets"], breaks = c(-.4,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(madrid2["bt_vs_tweets"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
View(bcn2)
plot(bcn2["bt_vs_tweets"], breaks = c(-.43,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(bcn2["bt_vs_pop"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(bcn2["bt_vs_tweets"], breaks = c(-.43,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(madrid2["bt_vs_pop"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(madrid2["bt_vs_tweets"], breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(ccaa["bt_vs_tweets"],breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(ccaa["bt_vs_pop"],breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
View(communities)
communities %>% arrange(desc(bt_vs_pop))
communities %>% arrange(desc(bt_vs_pop))
plot(ccaa["bt_vs_pop"],breaks = c(-.25,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
plot(ccaa["bt_vs_pop"],breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15,.25))
plot(ccaa["bt_vs_tweets"],breaks = c(-.2,-.15,-.10,-.075,-.05,-.025,0,.025,.05,.075,.1,.15))
# CCAA Analysis: no added value using tweets, no relationship w/ income
cor(communities$bt_vs_pop, communities$bt_vs_tweets)
# Muni Analysis: Pop & tweets not as closely correlated, still no relation w/ income
cor(municipalities$bt_vs_pop, municipalities$bt_vs_tweets, use = "complete.obs")
# Analysis: no relationship
cor(districts$bt_vs_pop, districts$bt_vs_tweets, use = "complete.obs")
ggplot(municipalities %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets > -.01)) + geom_point(aes(income, bt_vs_tweets)) + geom_smooth(aes(income, bt_vs_tweets), method = 'lm')
ggplot(municipalities %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets < .02)) + geom_point(aes(income, bt_vs_tweets)) + geom_smooth(aes(income, bt_vs_tweets), method = 'lm')
ggplot(municipalities %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets < .02 & bt_vs_tweets > -.01)) + geom_point(aes(income, bt_vs_tweets)) + geom_smooth(aes(income, bt_vs_tweets), method = 'lm')
summary(lm(bt_vs_pop ~ income, data = municipalities %>% filter(tw_count > 0 & bt_count > 0)))
summary(lm(bt_vs_pop ~ income, data = municipalities %>% filter(tw_count > 0 & bt_count > 0)))
summary(lm(bt_vs_pop ~ income, data = districts %>% filter(tw_count > 0 & bt_count > 0)))
ggplot(districts %>% filter(tw_count > 0 & bt_count > 0)) + geom_point(aes(income, bt_vs_tweets)) + geom_smooth(aes(income, bt_vs_tweets), method = 'lm')
ggplot() + geom_point(data = municipalities %>% filter(tw_count > 0 & bt_count > 0), aes(income, bt_vs_tweets)) + geom_smooth(data = municipalities, aes(income, bt_vs_tweets), method = 'lm')
ggplot() +
geom_point(data = municipalities %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets < .05 & bt_vs_tweets > -.05), aes(income, bt_vs_tweets)) +
geom_smooth(data = municipalities  %>% filter(tw_count > 0 & bt_count > 0), aes(income, bt_vs_tweets), method = 'lm')
ggplot() +
geom_point(data = districts %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets < .05 & bt_vs_tweets > -.05), aes(income, bt_vs_tweets)) +
geom_smooth(data = districts  %>% filter(tw_count > 0 & bt_count > 0), aes(income, bt_vs_tweets), method = 'lm')
ggplot() +
geom_point(data = districts %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets < .05 & bt_vs_tweets > -.02), aes(income, bt_vs_tweets)) +
geom_smooth(data = districts  %>% filter(tw_count > 0 & bt_count > 0), aes(income, bt_vs_tweets), method = 'lm')
ggplot() +
geom_point(data = districts %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets < .05 & bt_vs_tweets > -.15), aes(income, bt_vs_tweets)) +
geom_smooth(data = districts  %>% filter(tw_count > 0 & bt_count > 0), aes(income, bt_vs_tweets), method = 'lm')
ggplot() +
geom_point(data = districts %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets < .05 & bt_vs_tweets > -.015), aes(income, bt_vs_tweets)) +
geom_smooth(data = districts  %>% filter(tw_count > 0 & bt_count > 0), aes(income, bt_vs_tweets), method = 'lm')
ggplot() +
geom_point(data = districts %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets < .05 & bt_vs_tweets > -.02), aes(income, bt_vs_tweets)) +
geom_smooth(data = districts  %>% filter(tw_count > 0 & bt_count > 0), aes(income, bt_vs_tweets), method = 'lm')
ggplot() +
geom_point(data = districts %>% filter(tw_count > 0 & bt_count > 0 & bt_vs_tweets < .05 & bt_vs_tweets > -.01), aes(income, bt_vs_tweets)) +
geom_smooth(data = districts  %>% filter(tw_count > 0 & bt_count > 0), aes(income, bt_vs_tweets), method = 'lm')
min(tweets$timestamp)
head(tweets)
tail(tweets)
View(tweets)
tweets[18390:18400,]
tweets[18397:nrow(tweets),]
head(tweets[18397:nrow(tweets),])
head(tweets[18399:nrow(tweets),])
tail(tweets[18399:nrow(tweets),])
library(tidyverse)
library(arrow)
first <- 901
last <- 903
start <- Sys.time()
for (i in first:last){
filestart <- Sys.time()
file <- paste0("/Volumes/research/data_run2/chunk_",i,".parquet")
raw <- read_parquet(file) %>%
select(created_at, user.id, coordinates.coordinates) %>%
filter(map_lgl(coordinates.coordinates, ~ !is.null(.)))
raw <- suppressMessages(unnest_wider(raw, coordinates.coordinates))
names(raw) <- c("timestamp","user","lon","lat")
csv_name <- paste0("/Volumes/research/processed_tweeets/chunk_",i,"_pro.csv")
write_csv(raw, csv_name)
raw <- raw %>%
filter(lon > -9.39288367353 & lon < 3.03948408368) %>%
filter(lat > 35.946850084 & lat < 43.7483377142)
spain_name <- paste0("~/research/spain_tweets/spain_",i,".csv")
write_csv(raw, spain_name)
fileend <- Sys.time()
print(paste0("Chunk ",i," Completed | ",round((i-first)/(last-first)*100,1),"% of Set"))
print(paste0("Date range: ", min(raw$timestamp), " to ", max(raw$timestamp)))
print(fileend-filestart)
}
end <- Sys.time()
end-start
