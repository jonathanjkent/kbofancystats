list <- batters %>% subset(Season == "2019") %>% select(Team)
list <- unique(list$Team)
batleaders <- batters %>% select(Name.mykbo, Position, WAR, Season, Team)
pitleaders <- pitchers %>% select(Name.mykbo, Position, WAR, Season, Team)
leaders <- rbind(batleaders, pitleaders)
tops <- leaders %>% subset(Season == "2019") %>% group_by(Team) %>% top_n(3, WAR)
tops <- tops[order(-tops$WAR),]
tops$WAR <- round(tops$WAR, 2)
current.elos <- read_csv("~/Google Drive/KBO/currentelos.csv")
current.elos$Elo <- round(current.elos$Elo, 0)
for (i in list){
top3 <- tops %>% subset(Team == i)
top3 <- paste0("WAR Leader | ",top3[1,1],", ",top3[1,2],": ",top3[1,3])
elo <- current.elos %>% subset(Team == i)
elo <- paste0("Current Elo: ",elo[1,2]," | Elo Rank: ",elo[1,3])
a <- "---"
b <- 'date: "2020-03-31"'
c <- paste0("summary: ","'", top3,"'")
d <- paste0("title: ","'", i,"'")
da <- paste0("subtitle: ","'", elo,"'")
db <- "image:"
dc <- "  preview_only: true"
e <- "## 2019 Batting Stats"
f <- "```{r pressure, echo=F,warning=FALSE,message=FALSE}"
g <- "library(tidyverse)"
h <- "library(knitr)"
j <- "library(kableExtra)"
k <- 'batters <- read_csv("~/Google Drive/KBO/batters_simple.csv")'
l <- "batters <- batters[complete.cases(batters),]"
m <- "batters$Age <- as.numeric(batters$Age)"
n <- paste0('d <- batters %>% subset(Team == "', i, '") %>% subset(Season == "2019") %>% select(-Team, -Season, -KName)')
o <- "d <- d[order(-d$WAR),]"
p <- 'd$Name.mykbo <- paste0("[", d$Name.mykbo, "](/players/", d$ID, ")")'
q <- 'kable(d, digits = c(0,0,0,0,0,0,3,1,1,3,3,1,2), col.names = c("Name","Pos","Age","G","PA","HR","OPS","BB%","SO%","ISO","BABIP","wRC+","WAR")) %>% kable_styling(bootstrap_options = c("striped", "hover"), fixed_thead = T) %>%column_spec(1, bold = T, border_right = F)'
r <- "```"
s <- "## 2019 Pitching Stats"
t <- "```{r, echo=F,warning=FALSE,message=FALSE}"
u <- 'pitchers <- read_csv("~/Google Drive/KBO/pitchers_simple.csv")'
v <- 'pitchers <- pitchers[complete.cases(pitchers),]'
w <- paste0('d <- pitchers %>% subset(Team == "', i, '") %>% subset(Season == "2019") %>% select(-Team, -Season, -KName, -Position)')
x <- 'd <- d[order(-d$WAR),]'
y <- 'd$Name.mykbo <- paste0("[", d$Name.mykbo, "](/players/", d$ID, ")")'
ab <- "d <- d %>% select(-ID, -Name)"
z <- 'kable(d, digits = c(0,0,0,0,0,1,1,1,3,2,2,2), col.names = c("Name","Age","G","GS","IP","K/9","BB/9","HR/9","BABIP","ERA","FIP","WAR")) %>% kable_styling(bootstrap_options = c("striped", "hover"), fixed_thead = T) %>% column_spec(1, bold = T, border_right = F)'
teamwd <- paste0("~/Google Drive/KBO/kbofancystats/content/teams/",gsub("[[:space:]]", "", i))
setwd(teamwd)
file <- "index.rmd"
writeLines(c(a,b,c,d,da,db,dc,a,e,f,g,h,j,k,l,m,n,o,p,ab,q,r,s,t,u,v,w,x,y,ab,z,r), file)
}
View(batters.simple)
View(batters)
# Save/Read CSVs
#write_csv(pitchers, "pitchers.csv")
#write_csv(batters, "batters.csv")
pitchers <- read_csv("pitchers.csv")
batters <- read_csv("batters.csv")
setwd("~/Google Drive/KBO")
# Save/Read CSVs
#write_csv(pitchers, "pitchers.csv")
#write_csv(batters, "batters.csv")
pitchers <- read_csv("pitchers.csv")
batters <- read_csv("batters.csv")
View(batters)
# Add mykbo Names
namematches <- read_csv("namematches.csv")
pitchers <- pitchers %>% left_join(namematches, by = "ID")
batters <- batters %>% left_join(namematches, by = "ID")
# Clean IDs
pitchers$ID <- gsub("[[:punct:]]", "", pitchers$ID, perl=TRUE)
batters$ID <- gsub("[[:punct:]]", "", batters$ID, perl=TRUE)
# Add Park Factors
pf <- read_csv("parkfactors.csv")
batters <- batters %>% left_join(pf, by = "Team")
pitchers <- pitchers %>% left_join(pf, by = "Team")
batters$PF[is.na(batters$PF)] <- 1
pitchers$PF[is.na(pitchers$PF)] <- 1
# Fill NAs
batters$`2B`[is.na(batters$`2B`)] <- 0
batters$`3B`[is.na(batters$`3B`)] <- 0
batters$BA[is.na(batters$BA)] <- 0
batters$OBP[is.na(batters$OBP)] <- 0
batters$SLG[is.na(batters$SLG)] <- 0
batters$OPS[is.na(batters$OPS)] <- 0
batters$TB[is.na(batters$TB)] <- 0
batters$GDP[is.na(batters$GDP)] <- 0
batters$SH[is.na(batters$SH)] <- 0
batters$SF[is.na(batters$SF)] <- 0
batters$IBB[is.na(batters$IBB)] <- 0
pitchers$IBB[is.na(pitchers$IBB)] <- 0
pitchers$BK[is.na(pitchers$BK)] <- 0
pitchers$BF[is.na(pitchers$BF)] <- 0
# Create Guts
guts <- read_csv("guts.csv")
guts <- guts %>% subset(Season > 1998)
wBB <- mean(guts$wBB)
wHBP <- mean(guts$wHBP)
w1B <- mean(guts$w1B)
w2B <- mean(guts$w2B)
w3B <- mean(guts$w3B)
wHR <- mean(guts$wHR)
runSB <- mean(guts$runSB)
runCS <- mean(guts$runCS)
# Fix Basics
batters$`1B` <- batters$H-batters$`2B`-batters$`3B`-batters$HR
pitchers$IP2 <- pitchers$IP
pitchers <- pitchers %>% separate(IP, c("a", "b"))
pitchers$b[is.na(pitchers$b)] <- 0
pitchers$IP <- as.numeric(pitchers$a) + as.numeric(pitchers$b)*(1/3)
pitchers <- pitchers %>% select(-a, -b)
# Batter background
batters <- batters %>% group_by(Season) %>% summarize(lgAB = sum(AB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgPA = sum(PA)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgSF = sum(SF)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgBB = sum(BB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgIBB = sum(IBB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgHBP = sum(HBP)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgH = sum(H)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lg1B = sum(`1B`)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lg2B = sum(`2B`)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lg3B = sum(`3B`)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgHR = sum(HR)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgSB = sum(SB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgCS = sum(CS)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgR = sum(R)) %>% left_join(batters, by = "Season")
batters$lgRPA <- batters$lgR/batters$lgPA
batters$lgwOBA <- (wBB*(batters$lgBB-batters$lgIBB) + wHBP*batters$lgHBP + w1B*batters$lg1B + w2B*batters$lg2B + w3B*batters$lg3B + wHR*batters$lgHR)/(batters$lgPA)
batters$wOBAscale <- batters$lgwOBA/.250
batters$lgOBP <- (batters$lgH + batters$lgBB - batters$lgIBB + batters$lgHBP)/(batters$lgPA)
batters$lgwSB <- (batters$lgSB * runSB + batters$lgCS * runCS) / (batters$lg1B + batters$lgBB + batters$lgHBP - batters$lgIBB)
batters$lgwRC <- (batters$lgwOBA/batters$wOBAscale+batters$lgRPA)*batters$lgPA
# Batter Position Adjustment
batters$PosAdj <- as.factor(batters$Position)
batters$PosAdj <- fct_recode(batters$PosAdj, "12.5" = "C")
batters$PosAdj <- fct_recode(batters$PosAdj, "-12.5" = "1B")
batters$PosAdj <- fct_recode(batters$PosAdj, "2.5" = "2B", "2.5" = "3B", "2.5" = "CF")
batters$PosAdj <- fct_recode(batters$PosAdj, "7.5" = "SS")
batters$PosAdj <- fct_recode(batters$PosAdj, "-7.5" = "LF", "-7.5" = "RF")
batters$PosAdj <- fct_recode(batters$PosAdj, "-17.5" = "DH")
batters$PosAdj <- fct_recode(batters$PosAdj, "-17.5" = "DH")
batters$PosAdj <- fct_recode(batters$PosAdj, "-12.5" = "OF")
batters$PosAdj <- fct_recode(batters$PosAdj, "0" = "IF", "0" = "LHP", "0" = "RHP")
batters$PosAdj[is.na(batters$PosAdj)] <- "0"
batters$PosAdj <- as.character(batters$PosAdj)
batters$PosAdj <- parse_guess(batters$PosAdj)
# Pitcher background
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgIP = sum(IP)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgR = sum(R)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgER = sum(ER)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgSO = sum(SO)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgHR = sum(HR)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgBB = sum(BB)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgHBP = sum(HBP)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgGS = sum(GS)) %>% left_join(pitchers, by = "Season")
pitchers$lgGS <- pitchers$lgGS/2
gs <- pitchers %>% group_by(Season) %>% summarise(lgGS = mean(lgGS))
batters <- batters %>% left_join(gs, by = "Season")
pitchers$RPW <- 9*(pitchers$lgR/pitchers$lgIP)*1.5 + 3
rpw <- pitchers %>% group_by(Season) %>% summarise(RPW = mean(RPW))
batters <- batters %>% left_join(rpw, by = "Season")
pitchers$lgRA9 <- (pitchers$lgR/pitchers$lgIP)*9
pitchers$lgERA <- (pitchers$lgER/pitchers$lgIP)*9
pitchers$FIPcon <- pitchers$lgERA - (((13*pitchers$lgHR)+(3*(pitchers$lgBB+pitchers$lgHBP))-(2*pitchers$lgSO))/pitchers$lgIP)
pitchers$lgFIP <- ((13*pitchers$lgHR)+(3*(pitchers$lgBB+pitchers$lgHBP))-(2*pitchers$lgSO))/pitchers$lgIP + pitchers$FIPcon
pitchers$lgFIPR9 <- pitchers$lgFIP + (pitchers$lgRA9 - pitchers$lgERA)
# Batter Stats
batters$wOBA <- (wBB*(batters$BB-batters$IBB) + wHBP*batters$HBP + w1B*batters$`1B` + w2B*batters$`2B` + w3B*batters$`3B` + wHR*batters$HR)/(batters$PA)
batters$wRAA <- ((batters$wOBA-batters$lgwOBA)/batters$wOBAscale)*batters$PA
batters$WAR <- ((batters$wRAA + (batters$lgRPA - (batters$PF*(batters$lgRPA)))*batters$PA) + (batters$SB*runSB + batters$CS*runCS - batters$lgwSB * (batters$`1B` + batters$BB + batters$HBP - batters$IBB)) + (((batters$lgGS*.2345)*((batters$lgGS)/batters$lgGS))*(batters$RPW/batters$lgPA) * batters$PA)) + batters$PosAdj/batters$RPW
batters$wRC <- (((batters$wOBA-batters$lgwOBA)/batters$wOBAscale)+(batters$lgRPA))*batters$PA
batters$wRCplus <- (((batters$wRAA/batters$PA + batters$lgRPA) + (batters$lgRPA - batters$PF*batters$lgRPA))/(batters$lgRPA))*100
batters$BBpct <- (batters$BB/batters$PA)*100
batters$SOpct <- (batters$SO/batters$PA)*100
batters$ISO <- batters$SLG-batters$BA
batters$BABIP <- (batters$H - batters$HR)/(batters$AB - batters$SO - batters$HR + batters$SF)
View(batters)
library(tidyverse)
library(rvest)
setwd("~/Google Drive/KBO")
pitchers <- read_csv("pitchers.csv")
batters <- read_csv("batters.csv")
# Add mykbo Names
namematches <- read_csv("namematches.csv")
pitchers <- pitchers %>% left_join(namematches, by = "ID")
batters <- batters %>% left_join(namematches, by = "ID")
# Clean IDs
pitchers$ID <- gsub("[[:punct:]]", "", pitchers$ID, perl=TRUE)
batters$ID <- gsub("[[:punct:]]", "", batters$ID, perl=TRUE)
# Add Park Factors
pf <- read_csv("parkfactors.csv")
batters <- batters %>% left_join(pf, by = "Team")
pitchers <- pitchers %>% left_join(pf, by = "Team")
batters$PF[is.na(batters$PF)] <- 1
pitchers$PF[is.na(pitchers$PF)] <- 1
# Fill NAs
batters$`2B`[is.na(batters$`2B`)] <- 0
batters$`3B`[is.na(batters$`3B`)] <- 0
batters$BA[is.na(batters$BA)] <- 0
batters$OBP[is.na(batters$OBP)] <- 0
batters$SLG[is.na(batters$SLG)] <- 0
batters$OPS[is.na(batters$OPS)] <- 0
batters$TB[is.na(batters$TB)] <- 0
batters$GDP[is.na(batters$GDP)] <- 0
batters$SH[is.na(batters$SH)] <- 0
batters$SF[is.na(batters$SF)] <- 0
batters$IBB[is.na(batters$IBB)] <- 0
pitchers$IBB[is.na(pitchers$IBB)] <- 0
pitchers$BK[is.na(pitchers$BK)] <- 0
pitchers$BF[is.na(pitchers$BF)] <- 0
# Create Guts
guts <- read_csv("guts.csv")
guts <- guts %>% subset(Season > 1998)
wBB <- mean(guts$wBB)
wHBP <- mean(guts$wHBP)
w1B <- mean(guts$w1B)
w2B <- mean(guts$w2B)
w3B <- mean(guts$w3B)
wHR <- mean(guts$wHR)
runSB <- mean(guts$runSB)
runCS <- mean(guts$runCS)
# Fix Basics
batters$`1B` <- batters$H-batters$`2B`-batters$`3B`-batters$HR
pitchers$IP2 <- pitchers$IP
pitchers <- pitchers %>% separate(IP, c("a", "b"))
pitchers$b[is.na(pitchers$b)] <- 0
pitchers$IP <- as.numeric(pitchers$a) + as.numeric(pitchers$b)*(1/3)
pitchers <- pitchers %>% select(-a, -b)
# Batter background
batters <- batters %>% group_by(Season) %>% summarize(lgAB = sum(AB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgPA = sum(PA)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgSF = sum(SF)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgBB = sum(BB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgIBB = sum(IBB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgHBP = sum(HBP)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgH = sum(H)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lg1B = sum(`1B`)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lg2B = sum(`2B`)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lg3B = sum(`3B`)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgHR = sum(HR)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgSB = sum(SB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgCS = sum(CS)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgR = sum(R)) %>% left_join(batters, by = "Season")
batters$lgRPA <- batters$lgR/batters$lgPA
batters$lgwOBA <- (wBB*(batters$lgBB-batters$lgIBB) + wHBP*batters$lgHBP + w1B*batters$lg1B + w2B*batters$lg2B + w3B*batters$lg3B + wHR*batters$lgHR)/(batters$lgPA)
batters$wOBAscale <- batters$lgwOBA/.250
batters$lgOBP <- (batters$lgH + batters$lgBB - batters$lgIBB + batters$lgHBP)/(batters$lgPA)
batters$lgwSB <- (batters$lgSB * runSB + batters$lgCS * runCS) / (batters$lg1B + batters$lgBB + batters$lgHBP - batters$lgIBB)
batters$lgwRC <- (batters$lgwOBA/batters$wOBAscale+batters$lgRPA)*batters$lgPA
# Batter Position Adjustment
batters$PosAdj <- as.factor(batters$Position)
batters$PosAdj <- fct_recode(batters$PosAdj, "12.5" = "C")
batters$PosAdj <- fct_recode(batters$PosAdj, "-12.5" = "1B")
batters$PosAdj <- fct_recode(batters$PosAdj, "2.5" = "2B", "2.5" = "3B", "2.5" = "CF")
batters$PosAdj <- fct_recode(batters$PosAdj, "7.5" = "SS")
batters$PosAdj <- fct_recode(batters$PosAdj, "-7.5" = "LF", "-7.5" = "RF")
batters$PosAdj <- fct_recode(batters$PosAdj, "-17.5" = "DH")
batters$PosAdj <- fct_recode(batters$PosAdj, "-17.5" = "DH")
batters$PosAdj <- fct_recode(batters$PosAdj, "-12.5" = "OF")
batters$PosAdj <- fct_recode(batters$PosAdj, "0" = "IF", "0" = "LHP", "0" = "RHP")
batters$PosAdj[is.na(batters$PosAdj)] <- "0"
batters$PosAdj <- as.character(batters$PosAdj)
batters$PosAdj <- parse_guess(batters$PosAdj)
# Pitcher background
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgIP = sum(IP)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgR = sum(R)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgER = sum(ER)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgSO = sum(SO)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgHR = sum(HR)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgBB = sum(BB)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgHBP = sum(HBP)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgGS = sum(GS)) %>% left_join(pitchers, by = "Season")
pitchers$lgGS <- pitchers$lgGS/2
gs <- pitchers %>% group_by(Season) %>% summarise(lgGS = mean(lgGS))
batters <- batters %>% left_join(gs, by = "Season")
pitchers$RPW <- 9*(pitchers$lgR/pitchers$lgIP)*1.5 + 3
rpw <- pitchers %>% group_by(Season) %>% summarise(RPW = mean(RPW))
batters <- batters %>% left_join(rpw, by = "Season")
pitchers$lgRA9 <- (pitchers$lgR/pitchers$lgIP)*9
pitchers$lgERA <- (pitchers$lgER/pitchers$lgIP)*9
pitchers$FIPcon <- pitchers$lgERA - (((13*pitchers$lgHR)+(3*(pitchers$lgBB+pitchers$lgHBP))-(2*pitchers$lgSO))/pitchers$lgIP)
pitchers$lgFIP <- ((13*pitchers$lgHR)+(3*(pitchers$lgBB+pitchers$lgHBP))-(2*pitchers$lgSO))/pitchers$lgIP + pitchers$FIPcon
pitchers$lgFIPR9 <- pitchers$lgFIP + (pitchers$lgRA9 - pitchers$lgERA)
# Batter Stats
batters$wOBA <- (wBB*(batters$BB-batters$IBB) + wHBP*batters$HBP + w1B*batters$`1B` + w2B*batters$`2B` + w3B*batters$`3B` + wHR*batters$HR)/(batters$PA)
batters$wRAA <- ((batters$wOBA-batters$lgwOBA)/batters$wOBAscale)*batters$PA
batters$WAR <- ((batters$wRAA + (batters$lgRPA - (batters$PF*(batters$lgRPA)))*batters$PA) + (batters$SB*runSB + batters$CS*runCS - batters$lgwSB * (batters$`1B` + batters$BB + batters$HBP - batters$IBB)) + (((batters$lgGS*.2345)*((batters$lgGS)/batters$lgGS))*(batters$RPW/batters$lgPA) * batters$PA)) + batters$PosAdj/batters$RPW
batters$wRC <- (((batters$wOBA-batters$lgwOBA)/batters$wOBAscale)+(batters$lgRPA))*batters$PA
batters$wRCplus <- (((batters$wRAA/batters$PA + batters$lgRPA) + (batters$lgRPA - batters$PF*batters$lgRPA))/(batters$lgRPA))*100
batters$BBpct <- (batters$BB/batters$PA)*100
batters$SOpct <- (batters$SO/batters$PA)*100
batters$ISO <- batters$SLG-batters$BA
batters$BABIP <- (batters$H - batters$HR)/(batters$AB - batters$SO - batters$HR + batters$SF)
summary(batters$WAR)
summary(batters)
summary(batters$PosAdj)
(batters$wRAA + (batters$lgRPA - (batters$PF*(batters$lgRPA)))*batters$PA)
median((batters$wRAA + (batters$lgRPA - (batters$PF*(batters$lgRPA)))*batters$PA))
median((batters$wRAA + (batters$lgRPA - (batters$PF*(batters$lgRPA)))*batters$PA), na.omit = T)
(batters$SB*runSB + batters$CS*runCS - batters$lgwSB * (batters$`1B` + batters$BB + batters$HBP - batters$IBB))
(((batters$lgGS*.2345)*((batters$lgGS)/batters$lgGS))*(batters$RPW/batters$lgPA) * batters$PA))
(((batters$lgGS*.2345)*((batters$lgGS)/batters$lgGS))*(batters$RPW/batters$lgPA) * batters$PA))
(((batters$lgGS*.2345)*((batters$lgGS)/batters$lgGS))*(batters$RPW/batters$lgPA) * batters$PA)
summary((((batters$lgGS*.2345)*((batters$lgGS)/batters$lgGS))*(batters$RPW/batters$lgPA) * batters$PA))
batters$WAR <- ((batters$wRAA + (batters$lgRPA - (batters$PF*(batters$lgRPA)))*batters$PA) + (batters$SB*runSB + batters$CS*runCS - batters$lgwSB * (batters$`1B` + batters$BB + batters$HBP - batters$IBB)) + (((batters$lgGS*.2345)*((batters$lgGS)/batters$lgGS))*(batters$RPW/batters$lgPA) * batters$PA) + batters$PosAdj/batters$RPW
batters$WAR <- ((batters$wRAA + (batters$lgRPA - (batters$PF*(batters$lgRPA)))*batters$PA) + (batters$SB*runSB + batters$CS*runCS - batters$lgwSB * (batters$`1B` + batters$BB + batters$HBP - batters$IBB)) + (((batters$lgGS*.2345)*((batters$lgGS)/batters$lgGS))*(batters$RPW/batters$lgPA) * batters$PA)) + batters$PosAdj/batters$RPW
batters$WAR <- ((batters$wRAA + (batters$lgRPA - (batters$PF*(batters$lgRPA)))*batters$PA) + (batters$SB*runSB + batters$CS*runCS - batters$lgwSB * (batters$`1B` + batters$BB + batters$HBP - batters$IBB)) + (((batters$lgGS*.2345)*((batters$lgGS)/batters$lgGS))*(batters$RPW/batters$lgPA) * batters$PA) + batters$PosAdj)/batters$RPW
summary(batters$WAR)
pitchers <- read_csv("pitchers.csv")
batters <- read_csv("batters.csv")
# Add mykbo Names
namematches <- read_csv("namematches.csv")
pitchers <- pitchers %>% left_join(namematches, by = "ID")
batters <- batters %>% left_join(namematches, by = "ID")
# Clean IDs
pitchers$ID <- gsub("[[:punct:]]", "", pitchers$ID, perl=TRUE)
batters$ID <- gsub("[[:punct:]]", "", batters$ID, perl=TRUE)
# Add Park Factors
pf <- read_csv("parkfactors.csv")
batters <- batters %>% left_join(pf, by = "Team")
pitchers <- pitchers %>% left_join(pf, by = "Team")
batters$PF[is.na(batters$PF)] <- 1
pitchers$PF[is.na(pitchers$PF)] <- 1
# Fill NAs
batters$`2B`[is.na(batters$`2B`)] <- 0
batters$`3B`[is.na(batters$`3B`)] <- 0
batters$BA[is.na(batters$BA)] <- 0
batters$OBP[is.na(batters$OBP)] <- 0
batters$SLG[is.na(batters$SLG)] <- 0
batters$OPS[is.na(batters$OPS)] <- 0
batters$TB[is.na(batters$TB)] <- 0
batters$GDP[is.na(batters$GDP)] <- 0
batters$SH[is.na(batters$SH)] <- 0
batters$SF[is.na(batters$SF)] <- 0
batters$IBB[is.na(batters$IBB)] <- 0
pitchers$IBB[is.na(pitchers$IBB)] <- 0
pitchers$BK[is.na(pitchers$BK)] <- 0
pitchers$BF[is.na(pitchers$BF)] <- 0
# Create Guts
guts <- read_csv("guts.csv")
guts <- guts %>% subset(Season > 1998)
wBB <- mean(guts$wBB)
wHBP <- mean(guts$wHBP)
w1B <- mean(guts$w1B)
w2B <- mean(guts$w2B)
w3B <- mean(guts$w3B)
wHR <- mean(guts$wHR)
runSB <- mean(guts$runSB)
runCS <- mean(guts$runCS)
# Fix Basics
batters$`1B` <- batters$H-batters$`2B`-batters$`3B`-batters$HR
pitchers$IP2 <- pitchers$IP
pitchers <- pitchers %>% separate(IP, c("a", "b"))
pitchers$b[is.na(pitchers$b)] <- 0
pitchers$IP <- as.numeric(pitchers$a) + as.numeric(pitchers$b)*(1/3)
pitchers <- pitchers %>% select(-a, -b)
# Batter background
batters <- batters %>% group_by(Season) %>% summarize(lgAB = sum(AB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgPA = sum(PA)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgSF = sum(SF)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgBB = sum(BB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgIBB = sum(IBB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgHBP = sum(HBP)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgH = sum(H)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lg1B = sum(`1B`)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lg2B = sum(`2B`)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lg3B = sum(`3B`)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgHR = sum(HR)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgSB = sum(SB)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgCS = sum(CS)) %>% left_join(batters, by = "Season")
batters <- batters %>% group_by(Season) %>% summarize(lgR = sum(R)) %>% left_join(batters, by = "Season")
batters$lgRPA <- batters$lgR/batters$lgPA
batters$lgwOBA <- (wBB*(batters$lgBB-batters$lgIBB) + wHBP*batters$lgHBP + w1B*batters$lg1B + w2B*batters$lg2B + w3B*batters$lg3B + wHR*batters$lgHR)/(batters$lgPA)
batters$wOBAscale <- batters$lgwOBA/.250
batters$lgOBP <- (batters$lgH + batters$lgBB - batters$lgIBB + batters$lgHBP)/(batters$lgPA)
batters$lgwSB <- (batters$lgSB * runSB + batters$lgCS * runCS) / (batters$lg1B + batters$lgBB + batters$lgHBP - batters$lgIBB)
batters$lgwRC <- (batters$lgwOBA/batters$wOBAscale+batters$lgRPA)*batters$lgPA
# Batter Position Adjustment
batters$PosAdj <- as.factor(batters$Position)
batters$PosAdj <- fct_recode(batters$PosAdj, "12.5" = "C")
batters$PosAdj <- fct_recode(batters$PosAdj, "-12.5" = "1B")
batters$PosAdj <- fct_recode(batters$PosAdj, "2.5" = "2B", "2.5" = "3B", "2.5" = "CF")
batters$PosAdj <- fct_recode(batters$PosAdj, "7.5" = "SS")
batters$PosAdj <- fct_recode(batters$PosAdj, "-7.5" = "LF", "-7.5" = "RF")
batters$PosAdj <- fct_recode(batters$PosAdj, "-17.5" = "DH")
batters$PosAdj <- fct_recode(batters$PosAdj, "-17.5" = "DH")
batters$PosAdj <- fct_recode(batters$PosAdj, "-12.5" = "OF")
batters$PosAdj <- fct_recode(batters$PosAdj, "0" = "IF", "0" = "LHP", "0" = "RHP")
batters$PosAdj[is.na(batters$PosAdj)] <- "0"
batters$PosAdj <- as.character(batters$PosAdj)
batters$PosAdj <- parse_guess(batters$PosAdj)
# Pitcher background
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgIP = sum(IP)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgR = sum(R)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgER = sum(ER)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgSO = sum(SO)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgHR = sum(HR)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgBB = sum(BB)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgHBP = sum(HBP)) %>% left_join(pitchers, by = "Season")
pitchers <- pitchers %>% group_by(Season) %>% summarize(lgGS = sum(GS)) %>% left_join(pitchers, by = "Season")
pitchers$lgGS <- pitchers$lgGS/2
gs <- pitchers %>% group_by(Season) %>% summarise(lgGS = mean(lgGS))
batters <- batters %>% left_join(gs, by = "Season")
pitchers$RPW <- 9*(pitchers$lgR/pitchers$lgIP)*1.5 + 3
rpw <- pitchers %>% group_by(Season) %>% summarise(RPW = mean(RPW))
batters <- batters %>% left_join(rpw, by = "Season")
pitchers$lgRA9 <- (pitchers$lgR/pitchers$lgIP)*9
pitchers$lgERA <- (pitchers$lgER/pitchers$lgIP)*9
pitchers$FIPcon <- pitchers$lgERA - (((13*pitchers$lgHR)+(3*(pitchers$lgBB+pitchers$lgHBP))-(2*pitchers$lgSO))/pitchers$lgIP)
pitchers$lgFIP <- ((13*pitchers$lgHR)+(3*(pitchers$lgBB+pitchers$lgHBP))-(2*pitchers$lgSO))/pitchers$lgIP + pitchers$FIPcon
pitchers$lgFIPR9 <- pitchers$lgFIP + (pitchers$lgRA9 - pitchers$lgERA)
# Batter Stats
batters$wOBA <- (wBB*(batters$BB-batters$IBB) + wHBP*batters$HBP + w1B*batters$`1B` + w2B*batters$`2B` + w3B*batters$`3B` + wHR*batters$HR)/(batters$PA)
batters$wRAA <- ((batters$wOBA-batters$lgwOBA)/batters$wOBAscale)*batters$PA
batters$WAR <- ((batters$wRAA + (batters$lgRPA - (batters$PF*(batters$lgRPA)))*batters$PA) + (batters$SB*runSB + batters$CS*runCS - batters$lgwSB * (batters$`1B` + batters$BB + batters$HBP - batters$IBB)) + (((batters$lgGS*.2345)*((batters$lgGS)/batters$lgGS))*(batters$RPW/batters$lgPA) * batters$PA) + batters$PosAdj)/batters$RPW
batters$wRC <- (((batters$wOBA-batters$lgwOBA)/batters$wOBAscale)+(batters$lgRPA))*batters$PA
batters$wRCplus <- (((batters$wRAA/batters$PA + batters$lgRPA) + (batters$lgRPA - batters$PF*batters$lgRPA))/(batters$lgRPA))*100
batters$BBpct <- (batters$BB/batters$PA)*100
batters$SOpct <- (batters$SO/batters$PA)*100
batters$ISO <- batters$SLG-batters$BA
batters$BABIP <- (batters$H - batters$HR)/(batters$AB - batters$SO - batters$HR + batters$SF)
# Pitcher Stats
pitchers$FIP <- ((13*pitchers$HR)+(3*(pitchers$BB+pitchers$HBP))-(2*pitchers$SO))/pitchers$IP + pitchers$FIPcon
pitchers$FIPR9 <- pitchers$FIP + (pitchers$lgRA9 - pitchers$lgERA)
pitchers$pFIPR9 <- pitchers$FIPR9/pitchers$PF
pitchers$dRPW <- (((((18 - pitchers$IP/pitchers$G)*(pitchers$lgFIPR9)) + ((pitchers$IP/pitchers$G)*pitchers$pFIPR9)) / 18) + 2)*1.5
pitchers$RAAP9 <- pitchers$lgFIPR9 - pitchers$pFIPR9
pitchers$WPGAA <- pitchers$RAAP9 / pitchers$dRPW
pitchers$RepLev <- 0.03*(1 - pitchers$GS/pitchers$G) + 0.12*(pitchers$GS/pitchers$G)
pitchers$WPGAR <- pitchers$WPGAA + pitchers$RepLev
pitchers$WAR <- pitchers$WPGAR * (pitchers$IP/9)
#pitchers$WAR <- pitchers$WAR + (-0.0009*pitchers$IP)
pitchers$BABIP <- (pitchers$H - pitchers$HR)/(pitchers$BF - pitchers$BB - pitchers$IBB - pitchers$HBP - pitchers$SO - pitchers$HR)
# Summary Tables
batters.simple <- batters %>% select(Season, Name, KName, Name.mykbo, Position, ID, Team, Age, G, PA, HR, OPS, BBpct, SOpct, ISO, BABIP, wRCplus, WAR)
write_csv(batters.simple, "batters_simple.csv")
pitchers.simple <- pitchers %>% select(Season, Name, KName, Name.mykbo, Position, ID, Team, Age, G, GS, IP2, SO9, BB9, HR9, BABIP, ERA, FIP, WAR)
write_csv(pitchers.simple, "pitchers_simple.csv")
library(tidyverse)
setwd("~/Google Drive/KBO/kbofancystats/content/teams")
batters <- read_csv("~/Google Drive/KBO/batters_simple.csv")
pitchers <- read_csv("~/Google Drive/KBO/pitchers_simple.csv")
list <- batters %>% subset(Season == "2019") %>% select(Team)
list <- unique(list$Team)
batleaders <- batters %>% select(Name.mykbo, Position, WAR, Season, Team)
pitleaders <- pitchers %>% select(Name.mykbo, Position, WAR, Season, Team)
leaders <- rbind(batleaders, pitleaders)
tops <- leaders %>% subset(Season == "2019") %>% group_by(Team) %>% top_n(3, WAR)
tops <- tops[order(-tops$WAR),]
tops$WAR <- round(tops$WAR, 2)
current.elos <- read_csv("~/Google Drive/KBO/currentelos.csv")
current.elos$Elo <- round(current.elos$Elo, 0)
for (i in list){
top3 <- tops %>% subset(Team == i)
top3 <- paste0("WAR Leader | ",top3[1,1],", ",top3[1,2],": ",top3[1,3])
elo <- current.elos %>% subset(Team == i)
elo <- paste0("Current Elo: ",elo[1,2]," | Elo Rank: ",elo[1,3])
a <- "---"
b <- 'date: "2020-03-31"'
c <- paste0("summary: ","'", top3,"'")
d <- paste0("title: ","'", i,"'")
da <- paste0("subtitle: ","'", elo,"'")
db <- "image:"
dc <- "  preview_only: true"
e <- "## 2019 Batting Stats"
f <- "```{r pressure, echo=F,warning=FALSE,message=FALSE}"
g <- "library(tidyverse)"
h <- "library(knitr)"
j <- "library(kableExtra)"
k <- 'batters <- read_csv("~/Google Drive/KBO/batters_simple.csv")'
l <- "batters <- batters[complete.cases(batters),]"
m <- "batters$Age <- as.numeric(batters$Age)"
n <- paste0('d <- batters %>% subset(Team == "', i, '") %>% subset(Season == "2019") %>% select(-Team, -Season, -KName)')
o <- "d <- d[order(-d$WAR),]"
p <- 'd$Name.mykbo <- paste0("[", d$Name.mykbo, "](/players/", d$ID, ")")'
q <- 'kable(d, digits = c(0,0,0,0,0,0,3,1,1,3,3,1,2), col.names = c("Name","Pos","Age","G","PA","HR","OPS","BB%","SO%","ISO","BABIP","wRC+","WAR")) %>% kable_styling(bootstrap_options = c("striped", "hover"), fixed_thead = T) %>%column_spec(1, bold = T, border_right = F)'
r <- "```"
s <- "## 2019 Pitching Stats"
t <- "```{r, echo=F,warning=FALSE,message=FALSE}"
u <- 'pitchers <- read_csv("~/Google Drive/KBO/pitchers_simple.csv")'
v <- 'pitchers <- pitchers[complete.cases(pitchers),]'
w <- paste0('d <- pitchers %>% subset(Team == "', i, '") %>% subset(Season == "2019") %>% select(-Team, -Season, -KName, -Position)')
x <- 'd <- d[order(-d$WAR),]'
y <- 'd$Name.mykbo <- paste0("[", d$Name.mykbo, "](/players/", d$ID, ")")'
ab <- "d <- d %>% select(-ID, -Name)"
z <- 'kable(d, digits = c(0,0,0,0,0,1,1,1,3,2,2,2), col.names = c("Name","Age","G","GS","IP","K/9","BB/9","HR/9","BABIP","ERA","FIP","WAR")) %>% kable_styling(bootstrap_options = c("striped", "hover"), fixed_thead = T) %>% column_spec(1, bold = T, border_right = F)'
teamwd <- paste0("~/Google Drive/KBO/kbofancystats/content/teams/",gsub("[[:space:]]", "", i))
setwd(teamwd)
file <- "index.rmd"
writeLines(c(a,b,c,d,da,db,dc,a,e,f,g,h,j,k,l,m,n,o,p,ab,q,r,s,t,u,v,w,x,y,ab,z,r), file)
}
setwd("~/Google Drive/KBO/kbofancystats/content/players")
list <- batters %>% subset(Season == "2019") %>% select(Name.mykbo, ID, KName, Team, Position)
for (i in 1:nrow(list)){
title <- paste0(list$Name.mykbo[i], " | ", list$KName[i])
subtitle <- paste0(list$Team[i], " | ", list$Position[i])
id <- list$ID[i]
a <- "---"
b <- paste0('title: ', title)
bb <- paste0('subtitle: ', subtitle)
bc <- 'summary: "Career Stats"'
c <- "```{r pressure, echo=F,warning=FALSE,message=FALSE}"
d <- "library(tidyverse)"
e <- "library(knitr)"
f <- "library(kableExtra)"
g <- 'batters <- read_csv("~/Google Drive/KBO/batters_simple.csv")'
h <- 'batters$Age <- as.numeric(batters$Age)'
j <- paste0('d <- batters %>% subset(ID == "', id, '") %>% select(-Name, -Name.mykbo, -KName, -Position, -ID)')
k <- 'd <- d[order(-d$Season),]'
l <- 'kable(d, digits = c(0,0,0,0,0,0,3,1,1,3,3,1,2), col.names = c("Season","Team","Age","G","PA","HR","OPS","BB%","SO%","ISO","BABIP","wRC+","WAR")) %>% kable_styling(bootstrap_options = c("striped", "hover"), fixed_thead = T)'
m <- "```"
file <- paste0(gsub("[[:space:]]", "", id), ".rmd")
writeLines(c(a,b,bb,bc,a,c,d,e,f,g,h,j,k,l,m), file)
}
